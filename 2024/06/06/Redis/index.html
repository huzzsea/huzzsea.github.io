<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Redis | huzzsea</title><meta name="author" content="huzzsea"><meta name="copyright" content="huzzsea"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第一节	入门概述 基本介绍：全称 Remote Dictionary Server ，即远程字典服务，是一个完全开源的，使用 ANSIC 语言编写遵守 BSD 协议，高性能的 Key-Value 数据库，提供了丰富的数据结构，数据是存在内存中的，同时 Redis 支持事务、持久化、LUA 脚本、发布&#x2F;订阅、缓存淘汰、流技术等多种功能特性提供了主从模式、Redis Sentinel和Red">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2024/06/06/Redis/index.html">
<meta property="og:site_name" content="huzzsea">
<meta property="og:description" content="第一节	入门概述 基本介绍：全称 Remote Dictionary Server ，即远程字典服务，是一个完全开源的，使用 ANSIC 语言编写遵守 BSD 协议，高性能的 Key-Value 数据库，提供了丰富的数据结构，数据是存在内存中的，同时 Redis 支持事务、持久化、LUA 脚本、发布&#x2F;订阅、缓存淘汰、流技术等多种功能特性提供了主从模式、Redis Sentinel和Red">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-06-05T16:31:51.000Z">
<meta property="article:modified_time" content="2024-06-05T16:34:35.375Z">
<meta property="article:author" content="huzzsea">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/06/06/Redis/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-06 00:34:35'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="huzzsea"><span class="site-name">huzzsea</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-05T16:31:51.000Z" title="发表于 2024-06-06 00:31:51">2024-06-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-05T16:34:35.375Z" title="更新于 2024-06-06 00:34:35">2024-06-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="第一节入门概述"><a href="#第一节入门概述" class="headerlink" title="第一节	入门概述"></a>第一节	入门概述</h2><ul>
<li><p><strong>基本介绍</strong>：全称 <strong>Remote Dictionary Server</strong> ，即远程字典服务，是一个完全开源的，使用 <strong>ANSIC</strong> 语言编写遵守 <strong>BSD</strong> 协议，高性能的 <strong>Key-Value</strong> 数据库，提供了丰富的数据结构，数据是存在内存中的，同时 <strong>Redis</strong> 支持事务、持久化、<strong>LUA</strong> 脚本、发布&#x2F;订阅、缓存淘汰、流技术等多种功能特性提供了主从模式、<strong>Redis Sentinel和Redis Cluster</strong> 集群架构方案</p>
</li>
<li><p><strong>功能</strong></p>
<ul>
<li>分布式缓存，挡在 <strong>MySQL</strong> 数据库之前的一道屏障</li>
<li>内存存储和持久化，支持异步将内存中的数据写到硬盘上，同时不影响继续服务</li>
<li>高可用架构搭配</li>
<li>缓存穿透、击穿、雪崩</li>
<li>分布式锁</li>
<li>消息队列平台</li>
</ul>
</li>
<li><p><strong>优势</strong></p>
<ul>
<li>性能极高，读写速度快</li>
<li>数据类型丰富，不仅仅支持简单的 <strong>key-value</strong> 类型的数据，同时还提供 <strong>list</strong>，<strong>zset</strong>，<strong>set</strong>，<strong>hash</strong> 等数据结构的存储</li>
<li>支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用</li>
</ul>
</li>
<li><p><strong>Redis 启动命令</strong></p>
<ul>
<li><p><strong>默认启动</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server // 启动服务器</span><br><span class="line">redis-cli // 启动客户端</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>指定参数</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server --port 6379 --requirepass 12456 // 指定端口和密码</span><br><span class="line">redis-cli -p 6379 -a 123456 // 启动客户端</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置文件启动</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis-6379.conf // 启动服务器</span><br><span class="line">redis-cli // 启动客户端</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第二节数据类型"><a href="#第二节数据类型" class="headerlink" title="第二节	数据类型"></a>第二节	数据类型</h2><h3 id="2-1数据库"><a href="#2-1数据库" class="headerlink" title="2.1	数据库"></a>2.1	数据库</h3><ul>
<li><p><strong>键的相关操作</strong></p>
<ul>
<li><p>查询所有键</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断键是否存在</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看键的类型</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> key</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除指定键</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del key</span><br></pre></td></tr></table></figure>
</li>
<li><p>非阻塞删除</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unlink</span> key</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看过期时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttl key</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置过期时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expire key 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看键的数量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>数据库的相关操作</strong></p>
<ul>
<li><p>移动数据库</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move key [0-15]</span><br></pre></td></tr></table></figure>
</li>
<li><p>切换数据库</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> [0-15]</span><br></pre></td></tr></table></figure>
</li>
<li><p>清空当前数据库</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdb</span><br></pre></td></tr></table></figure>
</li>
<li><p>清空所有数据库</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-2字符串"><a href="#2-2字符串" class="headerlink" title="2.2	字符串"></a>2.2	字符串</h3><ul>
<li><p><strong>字符串类型</strong></p>
<ul>
<li><strong>Redis</strong> 最基本的类型，一个 <strong>key</strong> 对应一个 <strong>value</strong></li>
<li><strong>string</strong> 类型是二进制安全的，可以包含任何数据，比如jpg图片或者序列化的对象</li>
<li>一个字符串 <strong>value</strong> 最多可以是512M</li>
</ul>
</li>
<li><p><strong>SET 语句</strong></p>
<ul>
<li><p>添加键值对</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行条件</p>
<ul>
<li><p>键不存在时设置键值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value nx</span><br></pre></td></tr></table></figure>
</li>
<li><p>键存在时设置键值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value xx </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>设置过期时间</p>
<ul>
<li><p>以秒为单位设置过期时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value ex seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>以毫秒为单位设置过期时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value px milliseconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>以秒为单位设置以 <strong>UNIX</strong> 时间戳对应时间为过期时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value exat unix-time-seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>以毫秒为单位设置以 <strong>UNIX</strong> 时间戳对应时间为过期时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value pxat unix-time-milliseconds</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>保留设置前指定键的生存时间</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value keepttl</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>GET 语句</strong></p>
<ul>
<li><p>返回指定键的值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回指定键原本的值，并修改键值对</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getset key value</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>同时获取设置多对键值对</strong></p>
<ul>
<li><p>同时设置多对键值对</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mset key1 value1 key2 value2</span><br></pre></td></tr></table></figure>
</li>
<li><p>同时获取多对键值对</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mget key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>仅当键都不存在时，同时设置多对键值对</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msetnx key1 value1 key2 value2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>获取指定区间</strong></p>
<ul>
<li><p>获取键的全部值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getrange key 0 -1</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取键的指定区间值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getrange key 0 x</span><br></pre></td></tr></table></figure>
</li>
<li><p>替换键的指定区间值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setrange key x <span class="string">&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>数值增减</strong></p>
<ul>
<li><p>数值递增</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incr key</span><br></pre></td></tr></table></figure>
</li>
<li><p>数值相加</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incrby key</span><br></pre></td></tr></table></figure>
</li>
<li><p>数值递减</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr key</span><br></pre></td></tr></table></figure>
</li>
<li><p>数值相减</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decrby key</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>获取字符串长度和内容相加</strong></p>
<ul>
<li><p>获取键值长度</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串相加</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key value</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-3列表"><a href="#2-3列表" class="headerlink" title="2.3	列表"></a>2.3	列表</h3><ul>
<li><p><strong>列表类型</strong></p>
<ul>
<li>一个双端链表的结构，容量是2的32次方减1个元素，大概40多亿，主要功能有 <strong>push</strong>，<strong>pop</strong> 等，一般用在栈、队列、消息队列等场景</li>
<li><strong>left</strong>、<strong>right</strong> 都可以插入添加</li>
<li>底层就是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差</li>
</ul>
</li>
<li><p><strong>添加元素</strong></p>
<ul>
<li><p>左侧添加元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lpush key value</span><br></pre></td></tr></table></figure>
</li>
<li><p>右侧添加元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpush key value</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>获取元素</strong></p>
<ul>
<li><p>遍历列表</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrange key 0 -1</span><br></pre></td></tr></table></figure>
</li>
<li><p>左侧出栈</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lpop key</span><br></pre></td></tr></table></figure>
</li>
<li><p>右侧出栈</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpop key</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过索引获取值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lindex key index</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取元素个数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llen key</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>删除元素</strong></p>
<ul>
<li><p>从左到右删除指定数量的指定值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrem key num value</span><br></pre></td></tr></table></figure>
</li>
<li><p>从左到右删除所有指定值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrem key 0 value</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>修改元素</strong></p>
<ul>
<li><p>截取指定区间值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ltrim key index1 index2</span><br></pre></td></tr></table></figure>
</li>
<li><p>将最后一个值添加到另一个列表的第一个</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpoplpush key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改指定值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lset key index value</span><br></pre></td></tr></table></figure>
</li>
<li><p>在指定值前后插入值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linsert key before/after value1 value2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-4哈希表"><a href="#2-4哈希表" class="headerlink" title="2.4	哈希表"></a>2.4	哈希表</h3><ul>
<li><p><strong>哈希表类型</strong>：<strong>key-value</strong> 模式不变，但是 <strong>value</strong> 是一个键值对</p>
</li>
<li><p><strong>获取键值对</strong></p>
<ul>
<li><p>获取字段数量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hlen key</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断键值对中是否含有指定键</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexists key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取键值对中所有键</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hkeys key</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取键值对中所有值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hvals key</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>修改键值对</strong></p>
<ul>
<li><p>添加键值对</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hset key1 key2 value</span><br></pre></td></tr></table></figure>
</li>
<li><p>键值对中的指定键的值增加指定整数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hincrby key1 key2 num</span><br></pre></td></tr></table></figure>
</li>
<li><p>键值对中的指定键的值增加指定小数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hincrbyfloat key1 key2 num</span><br></pre></td></tr></table></figure>
</li>
<li><p>不存在赋值，存在失效</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hsetnx key1 key2 value</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-5集合"><a href="#2-5集合" class="headerlink" title="2.5	集合"></a>2.5	集合</h3><ul>
<li><p><strong>集合类型</strong>：单个 <strong>key</strong> 含有多个 <strong>value</strong>，且不重复</p>
</li>
<li><p><strong>常用操作</strong></p>
<ul>
<li><p>添加元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sadd key member</span><br></pre></td></tr></table></figure>
</li>
<li><p>遍历集合</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smenbers key</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断元素是否存在</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sismember key member</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srem key membr</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取集合长度</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scard key</span><br></pre></td></tr></table></figure>
</li>
<li><p>随机取出指定数量的元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srandmember key m</span><br></pre></td></tr></table></figure>
</li>
<li><p>随机删除指定数量的元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spop key m</span><br></pre></td></tr></table></figure>
</li>
<li><p>将集合内的指定元素赋值给另外一个集合</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smove key1 key2 member</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>集合运算</strong></p>
<ul>
<li><p>减运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdiff key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>交运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sinter key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>并运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sunion key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>交运算结果的基数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sintercard numkeys key1 key2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-6有序集合"><a href="#2-6有序集合" class="headerlink" title="2.6	有序集合"></a>2.6	有序集合</h3><ul>
<li><p><strong>有序集合类型</strong>：在集合的基础上加上一个 <strong>score</strong> 分数</p>
</li>
<li><p><strong>常用操作</strong></p>
<ul>
<li><p>添加元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zadd key score member</span><br></pre></td></tr></table></figure>
</li>
<li><p>以分数排序返回指定区间元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrange key index1 index2</span><br></pre></td></tr></table></figure>
</li>
<li><p>反序</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrevrange key index1 index2</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取指定分数区间的元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrangebyscore key min max [<span class="built_in">limit</span> offset count]</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取元素的分数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zscore key member</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取集合元素数量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcard key</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem key value</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加指定元素的分数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incrby key increment member</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取指定分数区间的元素数量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcount key min max</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取指定元素下标值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrank key values</span><br></pre></td></tr></table></figure>
</li>
<li><p>逆序获得下标值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrevrank key values</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-7位图"><a href="#2-7位图" class="headerlink" title="2.7	位图"></a>2.7	位图</h3><ul>
<li><p><strong>位图类型</strong></p>
<ul>
<li>用 <strong>string</strong> 类型作为底层数据结构实现的一种统计二值状态的数据类型</li>
<li>本质是数组，基于 <strong>string</strong> 数据类型的按位的操作，该数组由多个二进制位组成，每个二进制位都对应一个偏移量</li>
<li>支持的最大位数是2^32位，它可以极大的节约存储空间，使用512M内存就可以存储多达42.9亿的字节信息</li>
</ul>
</li>
<li><p><strong>常用操作</strong></p>
<ul>
<li><p>设置二进制位</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setbit key offset value</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取二进制位的值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getbit key offset</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取字节数</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>
</li>
<li><p>获得含有一的数量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitcount key</span><br></pre></td></tr></table></figure>
</li>
<li><p>并运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitop and destKey key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>或运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitop or destKey key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>异或运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitop xor destKey key1 key2</span><br></pre></td></tr></table></figure>
</li>
<li><p>非运算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitop not destKey key1 key2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-8基数统计"><a href="#2-8基数统计" class="headerlink" title="2.8	基数统计"></a>2.8	基数统计</h3><ul>
<li><p><strong>基数统计类型</strong></p>
<ul>
<li>去重复统计功能的基数估计算法</li>
<li>基数是一种数据集，去重复后的真实个数</li>
<li>用于统计一个集合中不重复的元素个数，就是对集合去重复后剩余元素的计算，只需要花费12KB内存，就能记录2的64次方个不同元素的基数</li>
</ul>
</li>
<li><p><strong>常用操作</strong></p>
<ul>
<li><p>添加元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfadd key value</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取指定基数估算值</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfcount key</span><br></pre></td></tr></table></figure>
</li>
<li><p>合并基数统计</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfmerge destKey sourceKey</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-9地理空间"><a href="#2-9地理空间" class="headerlink" title="2.9	地理空间"></a>2.9	地理空间</h3><ul>
<li><p><strong>地理空间类型</strong>： 使用二维的经纬度表示，经度范围 (-180, 180]，纬度范围 (-90, 90]，只要我们确定一个点的经纬度就可以名取得他在地球的位置</p>
</li>
<li><p><strong>常用操作</strong></p>
<ul>
<li><p>添加坐标</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd key longitude latitude member</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取经纬度</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geopos key member</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取坐标的bash32表示</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geohash key member</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取两个位置之间的距离</p>
<ul>
<li><p>以米为单位计算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist key member1 member2 m</span><br></pre></td></tr></table></figure>
</li>
<li><p>以千米为单位计算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist key member1 member2 km</span><br></pre></td></tr></table></figure>
</li>
<li><p>以英寸为单位计算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist key member1 member2 ft</span><br></pre></td></tr></table></figure>
</li>
<li><p>以英里为单位计算</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist key member1 member2 mi</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>获取指定距离内的位置元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">georadius key longitude latitude radius</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取指定范围内的元素</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">georadiusbymember key longitude latitude radius</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2-10流"><a href="#2-10流" class="headerlink" title="2.10	流"></a>2.10	流</h3><ul>
<li><p><strong>流类型</strong>：实现消息队列，支持消息的持久化、支持自动生成全局唯一 <strong>id</strong>、支持 <strong>ACK</strong> 确认消息的模式、支持消费组模式等，让消息队列更加的稳定和可靠</p>
</li>
<li><p><strong>流的结构</strong></p>
<ul>
<li><strong>消费组</strong>：由命令创建，同一消费组可以有多个消费者</li>
<li><strong>游标</strong>：每个消费组都有一个游标，任意消费者读取消息后都会使游标向前移动</li>
<li><strong>消费者</strong>：消费组中的消费者</li>
<li><strong>待处理编号</strong>：记录当前被消费已读取但未 <strong>ACK</strong> 的消息 <strong>id</strong></li>
</ul>
</li>
<li><p><strong>常用操作</strong></p>
<ul>
<li><p><strong>队列指令</strong></p>
<ul>
<li><p>添加到队列末尾</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xadd key field value</span><br></pre></td></tr></table></figure>
</li>
<li><p>限制流的长度</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrim key maxlen len</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除消息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xdel key <span class="built_in">id</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取消息长度</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xlen key</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取消息列表</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xrange key index1 index2</span><br></pre></td></tr></table></figure>
</li>
<li><p>反向获取消息列表</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xrevrange key index1 index2</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取消息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xread count block key <span class="built_in">id</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>消费组指令</strong></p>
<ul>
<li><p>创建消费者组</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xgroup create key groupname</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取消费者组的消息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xreadgroup group group consumer key <span class="built_in">id</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>消息被标记为已处理</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xack key group <span class="built_in">id</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置消费组最后递送消息的 <strong>id</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xgroup setid key groupname <span class="built_in">id</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除消费者组</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xgroup delconsumer key groupname consumername</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取待处理消息的详细信息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xpending key group index1 index2 count</span><br></pre></td></tr></table></figure>
</li>
<li><p>转移消息的归属权</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xclaim key group consumer time <span class="built_in">id</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打印消费者组的详细信息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xinfo <span class="built_in">groups</span> key</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印流的详细信息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xinfo stream key</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印流的详细信息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xinfo consumers key groupname</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>四个特殊符号</strong></p>
<ul>
<li>**+&#x2F;-**：最小和最大可能出现的 <strong>id</strong></li>
<li>**$**：表示只消费新的消息，当前流中最大的 <strong>id</strong></li>
<li>**&gt;**：用于 <strong>xreadgroup</strong> 命令，表示迄今没有发送给组中的使用者的消息</li>
<li>*****：用于 <strong>xadd</strong> 命令，让系统自动生成 <strong>id</strong></li>
</ul>
</li>
</ul>
<h3 id="2-11位域"><a href="#2-11位域" class="headerlink" title="2.11	位域"></a>2.11	位域</h3><ul>
<li><strong>位域类型</strong><ul>
<li>将很多小的整数存储到一个长度较大的位图中，又或者将一个非常庞大的键分割位多个较小的键来进行储存，从而高效利用内存</li>
<li>将 <strong>Redis</strong> 字符串看作是一个由二进制位组成的数组并能对变长位宽和任意没有字节对齐的指定整型位域进行寻址和修改</li>
</ul>
</li>
</ul>
<h2 id="第三节持久化"><a href="#第三节持久化" class="headerlink" title="第三节	持久化"></a>第三节	持久化</h2><h3 id="3-1RDB"><a href="#3-1RDB" class="headerlink" title="3.1	RDB"></a>3.1	RDB</h3><ul>
<li><p><strong>RDB</strong>：全称 <strong>Redis Data Base</strong>，即 <strong>Redis</strong> 数据库，<strong>RDB</strong> 持久性以指定的时间间隔执行数据集的时间点快照</p>
<ul>
<li>在指定的时间间隔，执行数据集的时间点快照</li>
<li>实现类似照片记录效果的方式，就是把某一时刻的数据和状态以文件的形式写到磁盘上，也就是快照，即使故障宕机，快照文件也不会丢失，数据的可靠性也就得到了保证</li>
<li>将内存数据全部保存到磁盘 <strong>dump.rdb</strong> 文件中</li>
</ul>
</li>
<li><p><strong>配置方法</strong></p>
<ul>
<li><p>配置保存间隔</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save 3600 1 300 100 60 100  // 3600秒 修改一次  100秒 修改60次  60秒 修改10000次 触发保存</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改快照文件保存地址</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> /user/local/dump</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改快照文件名称</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abfilename dump6666.rdb</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>恢复备份</strong></p>
<ul>
<li><strong>自动操作</strong>：物理恢复，一定服务和备份分机隔离，各自存储</li>
<li><strong>手动操作</strong><ul>
<li><strong>save</strong>：在主线程中执行会阻塞 <strong>Redis</strong> 服务器，直到持久化工作完成才能处理其他命令，线上禁止使用</li>
<li><strong>bgsave</strong>：在后台异步进行快照操作，不阻塞快照同时还可以响应客户端请求，该触发过程会 <strong>fork</strong> 一个子进程由子进程复制持久化过程</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>优缺点</strong></p>
<ul>
<li><strong>优点</strong>：适合大规模的数据恢复，按照业务定时备份，对数据完整性和一致性要求不高，<strong>RDB</strong> 文件在内存中的加载速度比 <strong>AOF</strong> 快得多</li>
<li><strong>缺点</strong><ul>
<li>在一定间隔时间做一次备份，如果 <strong>Redis</strong> 意外宕机，就会丢掉最近一次快照到宕机时的数据</li>
<li>内存数量的全量同步，如果数据量过大会导致 <strong>IO</strong> 严重影响服务器性能</li>
<li><strong>RDB</strong> 依赖于主进程的 <strong>fork</strong> ，在更大的数据集中，这可能会导致服务器请求的瞬间延迟</li>
<li><strong>fork</strong> 的时候内存中的数据被克隆了一份，大致2倍的膨胀性，需要考虑</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>检查修复快照文件</strong>：当文件受损时，检查并修复受损的文件</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-check-rdb dump.rdb</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>触发 RDB 快照的情况</strong></p>
<ul>
<li>配置文件中默认快照配置</li>
<li>手动执行 <strong>save</strong> 或者 <strong>bgsave</strong> 命令</li>
<li>执行清空数据库的命令</li>
<li>执行关机命令且没有开启 <strong>AOF</strong> 持久化</li>
<li>主从复制时，主节点自动触发</li>
</ul>
</li>
<li><p><strong>禁用快照</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>RDB 配置优化</strong></p>
<ul>
<li><p>保存错误时停止写入</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>快照压缩存储</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdbcompression <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>算法数据校验</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdbchecksum <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除复制中的快照文件启用</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdb-del-sync-files no</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="3-2AOF"><a href="#3-2AOF" class="headerlink" title="3.2	AOF"></a>3.2	AOF</h3><ul>
<li><p><strong>AOF 简介</strong>：以日志的形式来记录每个写操作，将 <strong>Redis</strong> 执行过的所有写指令记录下来（读操作不记录），只许追加文件但不可以改写文件，<strong>Redis</strong> 启动之初会读取该文件重新构建数据，即根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p>
</li>
<li><p><strong>AOF 持久化流程</strong></p>
<ul>
<li>客户端作为命令的来源，会有多个源头以及源源不断的请求命令</li>
<li>在这些命令到达服务器以后并不是直接写入 <strong>AOF</strong> 文件，会将这些命念先放入 <strong>AOF</strong> 缓存中进行保存，即内存中的一片区域，当这些命令达到一定量以后再写入磁盘，避免频繁的磁盘 <strong>IO</strong> 操作</li>
<li><strong>AOF</strong> 缓存会根据同步文件的三种写回策略将命令写入磁盘上 <strong>AOF</strong> 文件</li>
<li>随着写入 <strong>AOF</strong> 内容的增加为避免文件膨胀，会根据规则进行命令的合并，从而起到 <strong>AOF</strong> 文件压縮的目的</li>
<li>当服务器重启的时候会从 <strong>AOF</strong> 文件载入数据</li>
</ul>
</li>
<li><p><strong>AOF 缓冲区三种写回策略</strong></p>
<ul>
<li><strong>always</strong>：同步写回，每个写命令执行完立刻同步地将日志写回磁盘</li>
<li><strong>everysec</strong>：每秒写回，每个写命令执行完，只是先把日志写到 <strong>AOF</strong> 缓冲区，每隔1s把缓存区地数据写入磁盘</li>
<li><strong>no</strong>：操作系统控制写回，只是将日志先写到 <strong>AOF</strong> 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</li>
</ul>
</li>
<li><p><strong>AOF 配置优化</strong></p>
<ul>
<li><p>开启 <strong>AOF</strong> 持久化</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly no</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 <strong>AOF</strong> 文件保存路径</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appenddirname <span class="string">&quot;appendonlydir&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 <strong>AOF</strong> 文件名称</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>异常恢复</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-check-aof --fix appendonly.aof</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>优缺点</strong></p>
<ul>
<li><strong>优点</strong>：更好的保护数据不丢失、性能高、可做紧急恢复</li>
<li><strong>缺点</strong><ul>
<li>相同数据集的数据而言 <strong>AOF</strong> 文件要远大于 <strong>RDB</strong> 文件，恢复速度慢于 <strong>RDB</strong></li>
<li><strong>AOF</strong> 运行效率要慢于 <strong>RDB</strong>，每秒同步策略效率较好，不同步效率和 <strong>RDB</strong> 相同</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>AOF 重写机制</strong></p>
<ul>
<li><p>开启重写机制</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动触发</p>
<ul>
<li>满足配置文件中的选项后，<strong>Redis</strong> 会记录上次重写时的 <strong>AOF</strong> 大小</li>
<li>默认配置是当 <strong>AOF</strong> 文件大小是上次重写后大小的一倍且文件大于64M时触发</li>
</ul>
</li>
<li><p>手动触发</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bgrewriteaof</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="3-3RDB-AOF混合持久化"><a href="#3-3RDB-AOF混合持久化" class="headerlink" title="3.3	RDB-AOF混合持久化"></a>3.3	RDB-AOF混合持久化</h3><ul>
<li><strong>数据恢复顺序和加载顺序</strong>：在同时开启 <strong>RDB</strong> 和 <strong>AOF</strong> 持久化时，重启时只会加载 <strong>AOF</strong> 文件，不会加载 <strong>RDB</strong> 文件</li>
<li><strong>同时开启两种持久化方式</strong><ul>
<li>设置 <strong>aof-use-rdb-preamble</strong> 的值为 <strong>yes</strong>，开启混合方式持久化</li>
<li>当 <strong>Redis</strong> 重启时候会优先载入 <strong>AOF</strong> 文件来恢复原始的数据，在通常情况下 <strong>AOF</strong> 文件保存的数据集要比 <strong>RDB</strong> 文件保存的数据集要完整</li>
<li>当 <strong>RDB</strong> 的数据不实时，同时使用两者时服务器重启也只会找 <strong>AOF</strong> 文件</li>
</ul>
</li>
</ul>
<h3 id="3-4纯缓存模式"><a href="#3-4纯缓存模式" class="headerlink" title="3.4	纯缓存模式"></a>3.4	纯缓存模式</h3><ul>
<li><strong>同时关闭 RDB 和 AOF</strong><ul>
<li>禁用 <strong>RDB</strong> 持久化：<strong>save “”</strong> 命令，禁用 <strong>RDB</strong> 持久化模式下，仍然可以使用命令 <strong>save</strong>、<strong>bgsave</strong>生成 <strong>RDB</strong> 文件</li>
<li>禁用 <strong>AOF</strong>持久化：<strong>appendonly no</strong> 命令，禁用 <strong>AOF</strong> 持久化模式下，仍然可以使用命令 <strong>bgrewriteaof</strong> 生成 <strong>AOF</strong> 文件</li>
</ul>
</li>
</ul>
<h2 id="第四节事务"><a href="#第四节事务" class="headerlink" title="第四节	事务"></a>第四节	事务</h2><h3 id="4-1事务介绍"><a href="#4-1事务介绍" class="headerlink" title="4.1	事务介绍"></a>4.1	事务介绍</h3><ul>
<li><strong>Redis 事务介绍</strong><ul>
<li>可以一次执行多个命令，本质是一组命令的集合，一个事务中的所有命令都会序列化，按顺序地串行化执行而不会被其他命令插入，不许加塞</li>
<li>一个队列中，一次性、顺序性、排他性的执行一系列命令</li>
</ul>
</li>
<li><strong>Redis事务和数据库事务</strong><ul>
<li><strong>单独的隔离操作</strong>：仅仅保证事务里的操作会被连续地独占执行，在执行完所有指令之前不会同时执行其他客户端的请求</li>
<li><strong>没有隔离级别的概念</strong>：事务提交前不会执行任何指令，所有不存在隔离级别的概念</li>
<li><strong>不保证原子性</strong>：不保证所有指令同时成功或同时失败，没有执行到一半回滚的能力</li>
<li><strong>排它性</strong>：会保证一个事务内的命令依次执行，不会被其他命令插入</li>
</ul>
</li>
</ul>
<h3 id="4-2事务基本操作"><a href="#4-2事务基本操作" class="headerlink" title="4.2	事务基本操作"></a>4.2	事务基本操作</h3><ul>
<li><p><strong>事务命令</strong></p>
<ul>
<li><p>取消事务，放弃事务块内的所有命令</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">discard</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行事务块内的所有命令</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>标记一个事务块的开始</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br></pre></td></tr></table></figure>
</li>
<li><p>取消 <strong>watch</strong> 命令对所有 <strong>key</strong> 的监视</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unwatch</span><br></pre></td></tr></table></figure>
</li>
<li><p>监视一个或多个 <strong>key</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch key</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>事务操作</strong></p>
<ul>
<li><p>正常执行</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br><span class="line"><span class="built_in">exec</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>放弃事务</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br><span class="line">discard</span><br></pre></td></tr></table></figure>
</li>
<li><p>全体连坐：事务中含有语法错误时，全部指令都不会执行</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br><span class="line">// 语法错误</span><br><span class="line"><span class="built_in">exec</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>冤头债主：执行后错误时，不提供事务回滚，正确的指令依然会执行</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br><span class="line"><span class="built_in">exec</span></span><br><span class="line">// 执行错误</span><br></pre></td></tr></table></figure>
</li>
<li><p>监视：监视变量后，如果中途发生数据篡改，后续命令执行会失败</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">watch key</span><br><span class="line">// 加塞篡改</span><br><span class="line">multi</span><br><span class="line"><span class="built_in">exec</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第五节管道"><a href="#第五节管道" class="headerlink" title="第五节	管道"></a>第五节	管道</h2><h3 id="5-1管道介绍"><a href="#5-1管道介绍" class="headerlink" title="5.1	管道介绍"></a>5.1	管道介绍</h3><ul>
<li><p><strong>管道简介</strong></p>
<ul>
<li>可以一次性发送多条命令给服务端</li>
<li>服务端依次处理完完毕后，通过一条响应一次性将结果返回，通过减少客户端与 <strong>Redis</strong> 的通信次数来实现降低往返延时时间</li>
<li>管道实现的原理是队列，先进先出特性保证数据的顺序性</li>
<li>将多个命令都存在一个 <strong>txt</strong> 文件中，然后一同批处理，验证批处理</li>
</ul>
</li>
<li><p><strong>管道通信</strong>：<strong>Redis</strong> 是一种基于客户端-服务端模型以及请求&#x2F;响应协议的 <strong>TCP</strong> 服务，如果同时需要执行大量的命令，那么就要等待上一条命令应答后再执行，这中间不仅仅多了 <strong>RTT</strong>，而且还频繁调用系统 <strong>IO</strong>，发送网络请求，同时需要  <strong>Redis</strong> 调用多次读写系统方法，系统方法会将数据从用户态转移到内核态，会对进程上下文有较大的影响，管道通过一条响应一次性将结果返回，通过减少通信次数来实现降低往返延时时间</p>
</li>
</ul>
<h3 id="5-2管道操作"><a href="#5-2管道操作" class="headerlink" title="5.2	管道操作"></a>5.2	管道操作</h3><ul>
<li><p><strong>管道操作</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> cmd.txt | redis-cli --pipe</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>管道与原生批量</strong></p>
<ul>
<li>原生批量命令是原子性，而管道是非原子性</li>
<li>原生批量命令一次只能执行一种命令，而管道支持批量执行不同命令</li>
<li>原生批命令是服务端实现，而管道需要服务端与客户端共同完成</li>
</ul>
</li>
<li><p><strong>管道与事务</strong></p>
<ul>
<li>事务具有原子性，管道不具有原子性</li>
<li>管道一次性将多条命令发送到服务器，事务是一条一条发的，事务只有在接收到 <strong>exec</strong> 命令后才会执行，管道不会</li>
<li>执行事务时会阻塞其他命令的执行，而执行管道中的命令时不会</li>
</ul>
</li>
<li><p><strong>管道注意事项</strong></p>
<ul>
<li>管道缓冲的指令只是会依次执行，不保证原子性，如果执行中指令发生异常，将会继续执行后续的指令</li>
<li>使用管道组装的命令个数不能太多，不然数据量过大客户端阻塞的时间可能过久，同时服务器也被迫回复一个队列答复，占用很多内存</li>
</ul>
</li>
</ul>
<h2 id="第六节复制"><a href="#第六节复制" class="headerlink" title="第六节	复制"></a>第六节	复制</h2><h3 id="6-1复制介绍"><a href="#6-1复制介绍" class="headerlink" title="6.1	复制介绍"></a>6.1	复制介绍</h3><ul>
<li><strong>主从复制</strong>：将一台 <strong>Redis</strong> 服务器的数据，复制到其他的 <strong>Redis</strong> 服务器，前者称为主节点，后者称为从节点，数据的复制是单向的，只能由主节点到从节点，主节点以写为主，从节点以读为主，当主节点数据变化时，自动将新的数据异步同步到其他从节点数据库</li>
</ul>
<h3 id="6-2基本操作"><a href="#6-2基本操作" class="headerlink" title="6.2	基本操作"></a>6.2	基本操作</h3><ul>
<li><p><strong>配置方式</strong></p>
<ul>
<li><strong>配置文件</strong>：一次配置，持久稳定</li>
<li><strong>命令配置</strong>：当次生效</li>
</ul>
</li>
<li><p><strong>编辑 redis.conf 配置文件</strong></p>
<ul>
<li><p>修改端口号</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port 6379</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启守护进程模式</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <strong>pid</strong> 文件名</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pidfile <span class="string">&quot;/var/run/redis_6379.pid&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <strong>log</strong> 文件名</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logfile <span class="string">&quot;./log/6379.log&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>主从复制配置</strong></p>
<ul>
<li><p>去除配置文件中的从属关系</p>
</li>
<li><p>升级为主机</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaof/slaveof no one</span><br></pre></td></tr></table></figure>
</li>
<li><p>从机连接到主机</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaof/slaveof 192.168.1.100 6379</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看复制节点的主从关系和配置信息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info replication</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>主从复制结构</strong></p>
<ul>
<li><strong>一主多从结构</strong><ul>
<li>主机有读写能力，从机只有读能力</li>
<li>当主机宕机时，从机原地待命，不会变成主机</li>
<li>当主机恢复时，主从关系恢复正常</li>
</ul>
</li>
<li><strong>薪火相传结构</strong><ul>
<li>上一个从机也可以是下一个从机的主机，从机同样可以接受其他的从机的连接和同步请求</li>
<li>从机作为链条中下一个的主机，可以有效减轻主机的写压力</li>
<li>中途变更转向会清除之前的数据，重新建立拷贝最新的数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="6-3复制原理"><a href="#6-3复制原理" class="headerlink" title="6.3	复制原理"></a>6.3	复制原理</h3><ul>
<li><strong>主从复制原理</strong><ul>
<li><strong>从机启动</strong>，<strong>同步初请</strong><ul>
<li>从机启动成功连接到主机后会发送一个 <strong>sync</strong> 同步命令</li>
<li>从机首次全新连接主机，一次完全同步将被自动执行，原有数据将会被主机数据覆盖清除</li>
</ul>
</li>
<li><strong>首次连接</strong>，<strong>全量复制</strong><ul>
<li>主机节点收到同步命令后开始保存快照，同时收集所有接受接收到的数据修改命令，在执行快照持久化后，将所有的快照文件和缓存命令后发送到从机，完成一次同步</li>
<li>从机服务在接受到数据库文件操作后，将其存盘并加载到内存中，从而完成复制初始化</li>
</ul>
</li>
<li><strong>心跳持续</strong>，<strong>保持通信</strong><ul>
<li>设置复制周期 <strong>repl-ping-replica-period</strong> 参数</li>
<li>主机发出 <strong>ping</strong> 包的周期默认为10秒</li>
</ul>
</li>
<li><strong>进入平稳</strong>，<strong>增量复制</strong><ul>
<li>主机继续将新的所有收集到的修改命令自动一次传给从机，完成同步</li>
</ul>
</li>
<li><strong>从机下线</strong>，重传续传<ul>
<li>主机会检查 <strong>backlog</strong> 里面的 <strong>offset</strong>，主机和从机都会保存一个复制的 <strong>offset</strong> 怀有一个 <strong>masterId</strong></li>
<li><strong>offset</strong> 是保存在 <strong>backlog</strong> 中的，主机只会把已经复制的 <strong>offset</strong> 后面的数据赋值给从机，类似断电续传</li>
</ul>
</li>
</ul>
</li>
<li><strong>主从复制的缺点</strong><ul>
<li><strong>复制延时，信号衰弱</strong>：所有的写操作先在主机上操作，然后同步更新到从机上，存在一定的延迟<ul>
<li><strong>主机宕机</strong>：默认情况下当主机宕机时不会重选一个主机，需要人工干预</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="第七节哨兵"><a href="#第七节哨兵" class="headerlink" title="第七节	哨兵"></a>第七节	哨兵</h2><h3 id="7-1哨兵介绍"><a href="#7-1哨兵介绍" class="headerlink" title="7.1	哨兵介绍"></a>7.1	哨兵介绍</h3><ul>
<li><strong>哨兵介绍</strong>：哨兵巡查监控后主机是否故障，如果故障了根据投票数自动将某一个从库转换为新主库，继续对外服务，俗称无人值守运维</li>
<li><strong>哨兵的作用</strong><ul>
<li>监控 <strong>Redis</strong> 运行状态，包括主节点和从节点</li>
<li>当主节点宕机时，能自动将从节点切换成新主节点</li>
</ul>
</li>
<li><strong>哨兵的功能</strong><ul>
<li><strong>主从监控</strong>：监控主从 <strong>Redis</strong> 库运行是否正常</li>
<li><strong>消息通知</strong>：哨兵可以将故障转移的结果发送到客户端</li>
<li><strong>故障转移</strong>：如果主节点异常，则会进行主从切换，将其中一个从节点作为新主节点</li>
<li><strong>配置中心</strong>：客户端通过连接哨兵来获得当前 <strong>Redis</strong> 服务的主节点地址</li>
</ul>
</li>
</ul>
<h3 id="7-2基本操作"><a href="#7-2基本操作" class="headerlink" title="7.2	基本操作"></a>7.2	基本操作</h3><ul>
<li><p><strong>哨兵配置文件 sentinel.conf 参数</strong></p>
<ul>
<li><strong>bind</strong>：服务监听地址，用于客户端连接</li>
<li><strong>daemonize</strong>：守护进程模式</li>
<li><strong>protect-mode</strong>：安全保护模式</li>
<li><strong>port</strong>：端口号</li>
<li><strong>logfile</strong>：日志文件存放地址</li>
<li><strong>pidfile</strong>：<strong>pid</strong> 日志路径</li>
<li><strong>dir</strong>：工作目录</li>
<li><strong>sentinel monitor</strong><ul>
<li>设置要监视的主机</li>
<li>其中 <strong>quorum</strong> 参数表示最少有几个哨兵认可客观下线，同意故障迁移的法定票数</li>
</ul>
</li>
<li><strong>sentiel auth-pass</strong>：通过密码连接主机，对应主机 <strong>redis.conf</strong> 配置文件的 <strong>masterauth</strong> 参数</li>
</ul>
</li>
<li><p><strong>哨兵案例演示</strong></p>
<ul>
<li><p>启动一主多从的服务端和客户端</p>
</li>
<li><p>启动哨兵</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel26379.conf --sentinel</span><br><span class="line">redis-sentinel sentinel26380.conf --sentinel</span><br><span class="line">redis-sentinel sentinel26381.conf --sentinel</span><br></pre></td></tr></table></figure>
</li>
<li><p>当主机宕机时，会从从机中选举一个新的主机，如果主机恢复，则充当从机身份</p>
</li>
</ul>
</li>
</ul>
<h3 id="7-3哨兵原理"><a href="#7-3哨兵原理" class="headerlink" title="7.3	哨兵原理"></a>7.3	哨兵原理</h3><ul>
<li><strong>SDOWN 主观下线</strong><ul>
<li>单个哨兵主观上检测到关于主机的状态，如果发送 <strong>ping</strong> 包后在一定时间内没有收到合法的回复，就达到了主观下线的条件</li>
<li>哨兵配置文件中设置了 <strong>down-after-milliseconds</strong> 参数表示判断主观下线的时间长度</li>
</ul>
</li>
<li><strong>ODOWN 客观下线</strong><ul>
<li>需要一定数量的哨兵，多个哨兵达成一致意见才能认为一个主机客观上已经宕机</li>
<li>哨兵配置文件中设置了 <strong>quorum</strong> 参数表示判断主机宕机的最少哨兵数量</li>
</ul>
</li>
<li><strong>选举出领导者哨兵</strong><ul>
<li>当主节点被判断客观下线后，各哨兵会进行协商，先选举一个领导哨兵节点并由它进行故障迁移</li>
<li>使用 <strong>Raft</strong> 算法选出领导节点，算法的基本思路是先到先得，哨兵 <strong>A</strong> 向 <strong>B</strong> 发送成为领导者的请求，如果 <strong>B</strong> 没有同意其他哨兵的请求，则同意其成为领导者</li>
</ul>
</li>
<li><strong>领导者哨兵选举主机</strong><ul>
<li>过滤故障的节点</li>
<li>选择优先级 <strong>slave-priority</strong> 属性最大的从节点作为主节点，如不存在则继续</li>
<li>选择复制偏移量最大，即记录数据最多的从节点作为主节点，如不存在则继续</li>
<li>选择 <strong>runid</strong> 属性最小，即 <strong>Redis</strong> 随机标识最小的从节点作为主节点</li>
</ul>
</li>
<li><strong>哨兵选举流程</strong><ul>
<li><strong>新主登基</strong>：某一个从机备选成为新的主机</li>
<li><strong>群臣俯首</strong>：其他从机更新从属关系</li>
<li><strong>旧主拜服</strong>：原有的主机回来也会成为新主机的从机</li>
</ul>
</li>
<li><strong>哨兵的使用技巧</strong><ul>
<li>哨兵节点数量应为多个，保证高可用</li>
<li>哨兵节点数量应为奇数个</li>
<li>各个哨兵节点的配置应该保持一致</li>
<li>哨兵集群 + 主从复制并不能保证数据零丢失</li>
</ul>
</li>
</ul>
<h2 id="第八节集群"><a href="#第八节集群" class="headerlink" title="第八节	集群"></a>第八节	集群</h2><h3 id="8-1集群介绍"><a href="#8-1集群介绍" class="headerlink" title="8.1	集群介绍"></a>8.1	集群介绍</h3><ul>
<li><strong>集群简介</strong>：对多个复制集进行集群，形成水平扩展每个复制集只负责存储整个数据集的一部分，是一个提供在多个 <strong>Redis</strong> 节点间共享数据的程序集</li>
<li><strong>集群的功能</strong><ul>
<li>支持多个主机，每个主机又可以挂载多个从机</li>
<li>读写分离，支持海量数据的高可用，支持海量数据的读写存储操作</li>
<li>由于集群自带哨兵的故障转移机制，内置了高可用的支持，无需再去使用哨兵功能</li>
<li>客户端和 <strong>Redis</strong> 的节点连接，不再需要连接集群中所有节点，只需连接集群中的任意一个可用节点即可</li>
<li>槽位 <strong>slot</strong> 负责分配到各个物理服务节点，由对应的集群来负责维护节点、插槽和数据之间的关系</li>
</ul>
</li>
</ul>
<h3 id="8-2集群分布式存储"><a href="#8-2集群分布式存储" class="headerlink" title="8.2	集群分布式存储"></a>8.2	集群分布式存储</h3><ul>
<li><p><strong>哈希取余分区</strong></p>
<ul>
<li><strong>算法描述</strong>：<strong>hash(key) % N</strong> 个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上</li>
<li><strong>优点</strong>：简单粗暴，直接有效，只需要预估好数据规划节点，就能保证一段时间的数据支撑，使用 <strong>Hash</strong> 算法让固定的一部分请求落到同一台服务器上，每台服务器固定处理一部分请求，起到负载均衡和分而治之的作用</li>
<li><strong>缺点</strong><ul>
<li>直接规划好节点，进行扩容或者缩容会很麻烦，每次数据变动会导致节点有变动，映射关系都要重新计算</li>
<li>如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化，此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控</li>
<li>某个 <strong>Redis</strong> 机器宕机了，由于台数数量变化，会导致 <strong>hash</strong> 取余全部数据重新洗牌</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>一致性哈希算法分区</strong></p>
<ul>
<li><p><strong>算法描述</strong></p>
<ul>
<li>将整个哈希值组织成一个抽象的圆环，称为哈希环，哈希函数的输出值一般在0到 <strong>INT_MAX</strong> 之间，这些输出值可以均匀地映射到哈希环边上</li>
<li>将分布式系统的节点映射到圆环上，可以通过机器名称或 <strong>IP</strong> 地址将节点映射到环上</li>
<li>将需要存储的数据的关键字输入哈希函数，计算出哈希值，根据哈希值将数据映射到哈希环上</li>
<li>数据存储在按照顺时针方向遇到的第一个节点上</li>
</ul>
</li>
<li><p><strong>优点</strong></p>
<ul>
<li>容错性高，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器</li>
<li>扩展性高，添加服务器节点不会导致 <strong>hash</strong> 取余全部数据重新洗牌</li>
</ul>
</li>
<li><p><strong>缺点</strong>：在服务节点太少时，容易因为节点分布不均匀而造成数据倾斜问题</p>
</li>
</ul>
</li>
<li><p><strong>哈希槽分区</strong></p>
<ul>
<li><strong>算法描述</strong><ul>
<li>在数据和节点之间加入一层哈希槽，本质是一个数组，用于管理数据和节点之间的关系</li>
<li>一个集群只能有 16384个 槽，这些槽会分配给集群中的所有主节点，分配策略没有要求</li>
<li>集群会记录节点和槽的对应关系，需要对 <strong>key</strong> 求哈希值，然后对16384取模，根据余数落入对应的槽里</li>
<li>当需要在集群中放置一个节点时，先对 <strong>key</strong> 使用 <strong>crc16</strong> 算法算出一个结果然后用结果对16384取模，这样每个 <strong>key</strong> 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上</li>
</ul>
</li>
<li><strong>优点</strong>：很容易增加或删除节点，无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态</li>
<li><strong>缺点</strong>：集群不保证强一致性，在特定的条件下，可能会丢掉一些被系统收到的写入请求命令</li>
</ul>
</li>
</ul>
<h3 id="8-3集群配置"><a href="#8-3集群配置" class="headerlink" title="8.3	集群配置"></a>8.3	集群配置</h3><ul>
<li><p><strong>集群配置步骤</strong></p>
<ul>
<li><p>创建配置文件</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster-enabled <span class="built_in">yes</span> // 系统启用集群</span><br><span class="line">cluster-config-file nodes-6381.conf // 指定包含集群中节点信息的配置文件</span><br><span class="line">cluster-node-timeout 5000 // 检验集群中节点无响应的超时时间</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建集群关系</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server /myredis/cluster/redisCluter6381.conf // 启动服务器</span><br><span class="line">redis-cli --cluster create ip1:port1 ip2:port2 ip3:port3 ip4:port4 ip5:port5 ip6:port6 --cluster-replicas 1 // 构建主从关系</span><br></pre></td></tr></table></figure>
</li>
<li><p>检验集群状态</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a 123456 -p 6381 -c // 连接集群端口</span><br><span class="line">cluster nodes // 查看集群的主从关系</span><br><span class="line">cluster info // 查看集群信息</span><br><span class="line">info replication // 查看主从信息</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试集群</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster keyslot k1 // 查看键的槽位值</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>主从容错切换迁移</strong></p>
<ul>
<li><p>主机宕机，从机会成为主机，当原主机恢复时，不会重新成为主机</p>
</li>
<li><p>恢复原有主从关系</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER FAILOVER   // 在原始从机端口号下执行</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>主从扩容</strong></p>
<ul>
<li><p>新建主节点服务实例配置文件并启动</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis_7007.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>主节点 7007 加入集群</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node 192.168.3.100:7007 192.168.3.100:7001</span><br></pre></td></tr></table></figure>
</li>
<li><p>分配槽号，并输入分配槽位数量和插入节点 ID</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard 192.168.3.100:7007</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查集群情况</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster check 192.168.3.100:7001</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建从节点服务实例配置文件并启动</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis_7008.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>从节点 7008 加入集群</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node 192.168.3.100:7008 192.168.3.100:7001</span><br></pre></td></tr></table></figure>
</li>
<li><p>挂接从节点，参数为主节点的 ID</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7008&gt; cluster replicate 1d708c5042d53b6bc1e855ea41755782b6692e1a</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查集群情况</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>主从缩容</strong></p>
<ul>
<li><p>删除从节点，参数为待删除从节点的 ID</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster del-node 192.168.3.100:7001 cd26feeb271c1260ec134d85dcdeaf4c72bfc3ad</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭从节点 7008 服务</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 7008 shutdown</span><br></pre></td></tr></table></figure>
</li>
<li><p>分配槽位给其他主节点，并输入分配槽位数量和接受节点 ID，其中 done 表示结束</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard 192.168.3.100:7001</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除主节点，参数为待删除从节点的 ID</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster del-node 192.168.3.100:7001 1d708c5042d53b6bc1e855ea41755782b6692e1a</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭主节点 7007 服务</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 7007 shutdown</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第九节SpringBoot集成Redis"><a href="#第九节SpringBoot集成Redis" class="headerlink" title="第九节	SpringBoot集成Redis"></a>第九节	SpringBoot集成Redis</h2><h3 id="9-1Redis配置"><a href="#9-1Redis配置" class="headerlink" title="9.1	Redis配置"></a>9.1	Redis配置</h3><ul>
<li><p><strong>编写  redis.conf 配置文件</strong></p>
<ul>
<li><p>开启守护模式进程</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭安全保护模式</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected-mode=no</span><br></pre></td></tr></table></figure>
</li>
<li><p>注释服务监听地址</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加密码</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass=123456</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>防火墙配置</strong></p>
<ul>
<li><p>开启防火墙</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭防火墙</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>开机禁用防火墙</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>开机启用防火墙</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> firewalld</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="9-2Redis-Template"><a href="#9-2Redis-Template" class="headerlink" title="9.2	Redis Template"></a>9.2	Redis Template</h3><ul>
<li><p><strong>连接单机</strong></p>
<ul>
<li><p><strong>添加依赖</strong></p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置文件</strong></p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.data.redis.timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.data.redis.connectTimeout</span>=<span class="string">5000</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-idle</span>=<span class="string">8</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-active</span>=<span class="string">100   </span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-wait</span>=<span class="string">2000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置类</strong></p>
<ul>
<li><p><strong>Redis 配置</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String,Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="comment">//设置key序列化方式String</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value的序列化方式json，使用GenericJackson2JsonRedisSerializer替换默认的序列化</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>业务层</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderId</span><span class="params">(Integer keyId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(ORDER_KEY + keyId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>控制层</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/order/add&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        orderService.addOrder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/order/&#123;keyId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderId</span><span class="params">(<span class="meta">@PathVariable</span> Integer keyId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.getOrderId(keyId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>连接集群</strong></p>
<ul>
<li><p><strong>配置文件</strong></p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.redis.clusterspring.redis.cluster.nodes</span>=<span class="string">192.1.max-redirects=3</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-active</span>=<span class="string">8</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1ms</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-idle</span>=<span class="string">8</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">68.238.111</span>:<span class="string">6381,192.168.238.111:6382,192.168.238.112:6383,192.168.238.112:6384,192.168.238.113:6385,192.168.238.113:6386</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>设置刷新节点结群拓扑和动态感应</strong></p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.redis.lettuce.cluster.refresh.adaptive</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.cluster.refresh.period</span>=<span class="string">2000</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第十节多线程"><a href="#第十节多线程" class="headerlink" title="第十节	多线程"></a>第十节	多线程</h2><h3 id="10-1Redis单线程"><a href="#10-1Redis单线程" class="headerlink" title="10.1	Redis单线程"></a>10.1	Redis单线程</h3><ul>
<li><strong>Redis单线程</strong>：主要是指 <strong>Redis</strong> 的网络 <strong>IO</strong> 和键值对读写是由一个线程来完成的，<strong>Redis</strong> 在处理客户端的请求时包括获取 (<strong>socket</strong> 读)、解析、执行、内容返回 (<strong>socket</strong> 写) 等都由一个顺序串行的主线程处理</li>
<li><strong>单线程高性能的原因</strong><ul>
<li><strong>基于内存操作</strong>：所有 <strong>Redis</strong> 的数据都存在内存中，因此所有的运算都是内存级别的，所以他的性能高</li>
<li><strong>数据结构简单</strong>：<strong>Redis</strong> 的数据结构是专门设计的，这些简单的数据结构的查找和操作时间大部分复杂度都是 **O(1)**，性能高</li>
<li><strong>多路复用和非阻塞IO</strong>：<strong>Redis</strong> 使用 <strong>I&#x2F;O</strong> 多路复用功能来监听多个 <strong>socket</strong> 连接客户端，这样可以使用一个线程来处理多个请求，减少线程切换带来额开销，同时也避免了 <strong>I&#x2F;O</strong> 阻塞操作</li>
<li><strong>避免上下文切换</strong>：因为是单线程模型，因此就避免了不必要的上下文切换和多线程竞争，这就省去了多线程切换带来的时间和性能上的消耗，而且单线程不会导致死锁问题的发生</li>
</ul>
</li>
<li><strong>单线程的优势</strong><ul>
<li>使用单线程模型是 <strong>Redis</strong> 的开发和维护更简单，因为单线程模型方便开发和调试</li>
<li>即使使用单线程模型也并发的处理多客户端的请求，主要使用的是 <strong>IO</strong> 多路复用和非阻塞 <strong>IO</strong></li>
<li>对于 <strong>Redis</strong> 系统来说，主要的性能瓶颈是内存或者网络带宽而并非 <strong>CPU</strong></li>
</ul>
</li>
</ul>
<h3 id="10-2Redis多线程"><a href="#10-2Redis多线程" class="headerlink" title="10.2	Redis多线程"></a>10.2	Redis多线程</h3><ul>
<li><p><strong>Redis多线程的优势</strong>：惰性删除，可以有效避免 <strong>Redis</strong> 主线程卡顿，unlink key，flushdb async，flushall async</p>
</li>
<li><p><strong>Redis多线程特性</strong></p>
<ul>
<li>采用多个 <strong>IO</strong> 线程来处理网络请求，提高网络请求处理的并行度</li>
<li><strong>Redis 只是将 I&#x2F;O 读写变成了多线程，而命令的执行依旧是由主线程串行执行的</strong></li>
</ul>
</li>
<li><p><strong>主线程和IO线程的四个阶段</strong></p>
<ul>
<li><strong>服务端和客户端理立 Socket 连接，并分配处理线程</strong>：主线程负责接收建立连接请求，当有客户端请求和实例建立 <strong>Socket</strong> 连接时，主线程会创建和客户端的连接，并把 <strong>Socket</strong> 放入全局等待队列中，主线程通过轮询方法把 <strong>Socket</strong> 连接分配给 <strong>IO</strong> 线程</li>
<li><strong>IO 线程读取并解析请求</strong>：主线程一旦把 <strong>Socket</strong> 分配给 <strong>IO</strong> 线程，就会进入阻塞状态，等待 <strong>IO</strong> 线程完成客户端请求读取和解析</li>
<li><strong>主线程执行请求操作</strong>：等到 <strong>IO</strong> 线程解析完请求，主线程还是会以单线程的方式执行这些命令操作</li>
<li><strong>IO 线程回写 Socket 和主线程清空全局队列</strong>：当主线程执行完请求操作后，会把需要返回的结果写入缓冲区，主线程会阻塞等待 <strong>IO</strong> 线程，把这些结果回写到 <strong>Socket</strong> 中，并返回给客户端，和 <strong>IO</strong> 线程读取和解析请求一样，<strong>IO</strong> 线程回写 <strong>Socket</strong> 时，也是有多个线程在并发执行</li>
</ul>
</li>
<li><p><strong>多线程执行流程</strong></p>
  <img src="C:\Users\86172\Pictures\Markdown\Redis\1.png" style="zoom:67%;" />
</li>
<li><p><strong>Redis开启多线程</strong></p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">io-threads</span> <span class="string">4 # 线程数</span></span><br><span class="line"><span class="attr">io-thread-do-reads</span> <span class="string">yes # 启动多线程</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="第十一节BigKey"><a href="#第十一节BigKey" class="headerlink" title="第十一节	BigKey"></a>第十一节	BigKey</h2><h3 id="11-1MoreKey案例"><a href="#11-1MoreKey案例" class="headerlink" title="11.1	MoreKey案例"></a>11.1	MoreKey案例</h3><ul>
<li><p><strong>大量注入数据</strong></p>
<ul>
<li><p>生成数据并保存</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for((i=1;i&lt;=100*10000;i++)); do echo &quot;set k$i v$i&quot; &gt;&gt; /tmp/redisTest.txt ;done;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成100W条redis批量设置kv的语句(key=kn,value=vn)写入到/tmp目录下的redisTest.txt文件中</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过管道插入数据</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/redisTest.txt | redis-cli -h 127.0.0.1 -p 6379 -a 123456 --pipe</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>危险命令</strong></p>
<ul>
<li><p><strong>keys * &#x2F; flushall &#x2F; flushdb</strong></p>
</li>
<li><p>严禁在线上使用，会造成阻塞，会导致 <strong>Redis</strong> 其他的读写都被延后甚至是超时报错，可能会引起缓存雪崩甚至数据库宕机</p>
</li>
<li><p>通过配置禁用危险命令</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rename-command</span> <span class="string">keys &quot;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>Scan命令</strong></p>
<ul>
<li><p>基于游标的迭代器，每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为 <strong>SCAN</strong> 命令的游标参数， 以此来延续之前的迭代过程</p>
</li>
<li><p>返回一个包含两个元素的数组， 第一个元素是用于进行下一次迭代的新游标， 第二个元素则是一个数组， 这个数组中包含了所有被迭代的元素,如果新游标返回零表示迭代已结束</p>
</li>
<li><p>遍历顺序非常特别，它不是从第一维数组的第零位一直遍历到末尾，而是采用了高位进位加法来遍历，考虑到字典的扩容和缩容时避免槽位的遍历重复和遗漏</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scan 0 match * count 10</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="11-2BigKey案例"><a href="#11-2BigKey案例" class="headerlink" title="11.2	BigKey案例"></a>11.2	BigKey案例</h3><ul>
<li><p><strong>BigKey概述</strong></p>
<ul>
<li><strong>string</strong> 类型控制在 <strong>10KB</strong> 以内</li>
<li><strong>hash</strong>，<strong>list</strong>，<strong>set</strong>，<strong>zset</strong> 的元素个数不要超过5000</li>
<li>非字符串类型的 <strong>BigKey</strong> 不要使用 <strong>del</strong> 删除，使用渐进式方式删除</li>
</ul>
</li>
<li><p><strong>BigKey的危害</strong></p>
<ul>
<li>内存不均，集群迁移困难</li>
<li>超时删除，导致阻塞</li>
<li>网络流量阻塞</li>
</ul>
</li>
<li><p><strong>检测BigKey</strong></p>
<ul>
<li><p>查询 <strong>BigKey</strong></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --bigkeys</span><br></pre></td></tr></table></figure>
</li>
<li><p>计算每个键值的字节数</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory usage [key]</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>删除BigKey</strong></p>
<ul>
<li><strong>string 类型</strong>：一般用 <strong>del</strong>，过于庞大 <strong>unlink</strong></li>
<li><strong>hash 类型</strong>：使用 <strong>hscan</strong> 每次获取少量 <strong>field-value</strong>，再使用 <strong>hdel</strong> 删除每个 <strong>field</strong></li>
<li><strong>list 类型</strong>：使用 <strong>ltrim</strong> 渐进式逐步删除，直到全部删除</li>
<li><strong>set 类型</strong>：使用 <strong>sscan</strong> 每次获取部分元素，再使用 <strong>srem</strong> 命令删除每个元素</li>
<li><strong>zset 类型</strong>：使用 <strong>zscan</strong> 每次获取部分元素，再使用 <strong>ZREMRANGEBYRANK</strong> 命令删除每个元素</li>
</ul>
</li>
</ul>
<h3 id="11-3BigKey生产调优"><a href="#11-3BigKey生产调优" class="headerlink" title="11.3	BigKey生产调优"></a>11.3	BigKey生产调优</h3><ul>
<li><strong>阻塞和非阻塞删除命令</strong>：使用 <strong>UNLIKE</strong> 命令非阻塞删除键值对</li>
<li><strong>优化配置</strong><ul>
<li>lazyfree-lazy-eviction：是否异步驱逐key，当内存达到上限，分配失败后</li>
<li>lazyfree-lazy-expire：是否异步进行key过期事件的处理</li>
<li>lazyfree-lazy-server-del：del命令是否异步执行删除操作，类似unlink</li>
<li>replica-lazy-flush：replica client做全同步的时候，是否异步flush本地db</li>
</ul>
</li>
</ul>
<h2 id="第十二节缓存双写一致性"><a href="#第十二节缓存双写一致性" class="headerlink" title="第十二节	缓存双写一致性"></a>第十二节	缓存双写一致性</h2><h3 id="12-1缓存双写一致性"><a href="#12-1缓存双写一致性" class="headerlink" title="12.1	缓存双写一致性"></a>12.1	缓存双写一致性</h3><ul>
<li><p><strong>缓存一致性</strong></p>
<ul>
<li>如果 <strong>redis</strong> 中有数据，需要和数据库中的值相同</li>
<li>如果 <strong>redis</strong> 中无数据，数据库中的值是最新值，且准备回写redis</li>
</ul>
</li>
<li><p><strong>回写策略</strong></p>
<ul>
<li><strong>同步直写策略</strong><ul>
<li>写数据库后也同步写 <strong>redis</strong> 缓存，缓存中的数据和数据中的一致</li>
<li>对于读写缓存来说，要想保证缓存和数据库中的数据一致</li>
</ul>
</li>
<li><strong>异步缓写策略</strong><ul>
<li>正常业务运行中，<strong>mysql</strong> 数据变动了，但是可以在业务上容许出现一定时间后才作用于 <strong>redis</strong>，比如仓库、物流系统</li>
<li>异常情况出现了，不得不讲失败的动作重新修补，有可能需要借助 <strong>kafka</strong> 或者 <strong>RabbitMQ</strong> 等消息中间件，实现重写重试</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>双检加锁策略</strong></p>
<ul>
<li><p>多个线程同时去查询数据库的这条数据，就在第一个查询数据的请求上使用一个互斥锁来锁住他</p>
</li>
<li><p>其他线程获取不到锁就一直等待，等第一个线程查询到了数据，然后做了缓存</p>
</li>
<li><p>后面的线程进来发现已经有了缓存，就直接走缓存</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_USER</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span>;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_KEY_USER + id;</span><br><span class="line"></span><br><span class="line">        user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (UserServiceImpl.class)&#123;</span><br><span class="line">                user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">                <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">                    user = userMapper.selectById(id);</span><br><span class="line">                    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        redisTemplate.opsForValue().setIfAbsent(key, user, <span class="number">7L</span>, TimeUnit.DAYS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="12-2更新策略"><a href="#12-2更新策略" class="headerlink" title="12.2	更新策略"></a>12.2	更新策略</h3><ul>
<li><p><strong>可停机的情况</strong>：挂牌报错，凌晨升级，服务降级，温馨提示，最好单线程操作</p>
</li>
<li><p><strong>不可停机的情况</strong></p>
<ul>
<li><p><strong>异常更新策略</strong></p>
<table>
<thead>
<tr>
<th align="center">策略</th>
<th align="center">存在的问题</th>
</tr>
</thead>
<tbody><tr>
<td align="center">先更新数据库，再更新缓存</td>
<td align="center">缓存更新异常，缓存读到脏数据；高并发环境下，数据不一致</td>
</tr>
<tr>
<td align="center">先更新缓存，再更新数据库</td>
<td align="center">高并发环境下，数据不一致</td>
</tr>
<tr>
<td align="center">先删除缓存，再更新数据库（<strong>解决方案</strong>：延时双删策略）</td>
<td align="center">数据库更新期间，缓存被更新依旧是脏数据</td>
</tr>
</tbody></table>
</li>
<li><p><strong>最佳更新策略</strong>：先更新数据库，再删除缓存</p>
<ul>
<li><strong>存在的问题</strong>：缓存删除不及时，请求会读取到脏数据</li>
<li><strong>解决方案</strong><ul>
<li>使用 <strong>canal</strong> 订阅数据库更新日志，实时更新缓存中的数据</li>
<li>使用 <strong>Kafka</strong> 等消息中间件，将更新后的数据放入消息队列，循环尝试删除</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>延迟双删策略</strong>：线程休眠一段时间后，再次删除缓存中的数据</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDoubleOrderDelay</span><span class="params">(Order order)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> RedisUtils.getJdis())&#123;</span><br><span class="line">        jedis.del(order.getId() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        orderDao.update(order);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Completable.supplyAsnyc(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> jedis.del(order.getId() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;),get();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Excepton e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="第十三节大数据统计"><a href="#第十三节大数据统计" class="headerlink" title="第十三节	大数据统计"></a>第十三节	大数据统计</h2><h3 id="13-1四种统计"><a href="#13-1四种统计" class="headerlink" title="13.1	四种统计"></a>13.1	四种统计</h3><ul>
<li><strong>聚合统计</strong>：统计多个集合元素的聚合结果（交并差集合统计），使用 <strong>set</strong></li>
<li><strong>排序统计</strong>：需要展示最新列表、排行榜等场景时，如果数据更新频繁或者需要分页显示，使用 <strong>zset</strong></li>
<li><strong>二值统计</strong>：集合元素的取值就只有 0 和 1，使用 <strong>BitMap</strong></li>
<li><strong>基数统计</strong>：只统计一个集合中不重复的元素个数，使用 <strong>hyperloglog</strong></li>
</ul>
<h3 id="13-2hyperloglog"><a href="#13-2hyperloglog" class="headerlink" title="13.2	hyperloglog"></a>13.2	hyperloglog</h3><ul>
<li><strong>hyperloglog</strong>：是一种数据集，表示去重复后的真实个数，只需要花费 12KB 内存，就可以计算接近 2 的 64 次方个不同元素的基数，但是会有 0.81% 左右的误差</li>
<li><strong>统计数据</strong><ul>
<li><strong>UV</strong>：Unique Visitor，独立访客，一般理解为客户端IP （<strong>需要考虑去重</strong>）</li>
<li><strong>PV</strong>：Page View，页面浏览量，不用去重</li>
<li><strong>DAU</strong>：Daily Active User，日活跃用户量，登录或者使用了某个产品的用户数（去重复登录的用户），常用于反映网站、互联网应用或者网络游戏的运营情况</li>
<li><strong>MAU</strong>：Monthly Active User，月活跃用户量</li>
</ul>
</li>
</ul>
<h3 id="13-3统计亿级UV的Redis方案"><a href="#13-3统计亿级UV的Redis方案" class="headerlink" title="13.3	统计亿级UV的Redis方案"></a>13.3	统计亿级UV的Redis方案</h3><ul>
<li><p><strong>技术选型</strong></p>
<ul>
<li><strong>mysql</strong>：<strong>mysql</strong> 扛不住稍微大一点的并发，而且都需要存入 <strong>mysql</strong> 中，导致 <strong>mysql</strong> 的检索也会变慢</li>
<li><strong>redis 的 hash 结构存储</strong>：内存容量不足</li>
<li><strong>hyperloglog</strong>：在 <strong>Redis</strong> 里面，每个 <strong>HyperLogLog</strong> 键只需要花费 12KB 内存，就可以计算接近 2 的 64 次方个不同元素的基数</li>
</ul>
</li>
<li><p><strong>统计案例</strong></p>
<ul>
<li><p>服务层接口</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HypeLogLogService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">uv</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务层实现类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HypeLogLogServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">HypeLogLogService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initIp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">                <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                ip = random.nextInt(<span class="number">256</span>) + <span class="string">&quot;.&quot;</span> + random.nextInt(<span class="number">256</span>) + <span class="string">&quot;.&quot;</span> + random.nextInt(<span class="number">256</span>) + <span class="string">&quot;.&quot;</span> + random.nextInt(<span class="number">256</span>);</span><br><span class="line">                <span class="type">Long</span> <span class="variable">hll</span> <span class="operator">=</span> redisTemplate.opsForHyperLogLog().add(<span class="string">&quot;hll&quot;</span>, ip);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">uv</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(<span class="string">&quot;hll&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HyperLogLogController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HypeLogLogService hypeLogLogService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/uv&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">uv</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hypeLogLogService.uv();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第十四节实战GEO"><a href="#第十四节实战GEO" class="headerlink" title="第十四节	实战GEO"></a>第十四节	实战GEO</h2><ul>
<li><p><strong>技术选型</strong></p>
<ul>
<li><strong>mysql</strong><ul>
<li>查询性能问题，并发高、数据量大这种查询要搞垮 <strong>mysql</strong> 数据库</li>
<li>一般 <strong>mysql</strong> 查询的是一个平面矩形访问，而叫车服务要以我为中心N公里为半径的圆形覆盖</li>
<li>精准度的问题，我们知道地球不是平面坐标系，而是一个圆球，这种矩形计算在长距离计算时会有很大误差，<strong>mysql</strong> 不合适</li>
</ul>
</li>
<li><strong>GEO</strong>：可以解决上述问题</li>
</ul>
</li>
<li><p><strong>GEO 命令</strong></p>
<ul>
<li><p><strong>GEOADD</strong>：添加经纬度坐标</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd city 116.0 39,0 &quot;北京&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GEOPOS</strong>：返回经纬度</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geopos city &quot;北京&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GEOHASH</strong>：返回坐标的 <strong>geohash</strong> 表示</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geohash city &quot;北京&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GEODIST</strong>：返回两个位置之间的距离</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist city &quot;北京&quot; &quot;南京&quot; km</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GEORADIUS</strong>：以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">georadius city 116.0 39,0 10 km withdist withcoord count 10 desc</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GEORADIUSBYMEMBER</strong>：找出指定范围内的元素，中心点是由给定的位置元素决定</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">georadiusbymember city 116.0 39,0 10 km withdist withcoord count 10 withhash</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>查询案例</strong></p>
<ul>
<li><p>服务层接口</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GeoService</span> &#123;</span><br><span class="line">    String <span class="title function_">geoAdd</span><span class="params">()</span>;</span><br><span class="line">    Point <span class="title function_">position</span><span class="params">(String member)</span>;</span><br><span class="line">    String <span class="title function_">hash</span><span class="params">(String member)</span>;</span><br><span class="line">    Distance <span class="title function_">distance</span><span class="params">(String member1, String member2)</span>;</span><br><span class="line">    GeoResults <span class="title function_">radiusByxy</span><span class="params">()</span>;</span><br><span class="line">    GeoResults <span class="title function_">radiusMember</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务层实现类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeoServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">GeoService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CITY</span> <span class="operator">=</span> <span class="string">&quot;city&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">geoAdd</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Point&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;白马寺&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">112.610356</span>,<span class="number">34.728481</span>));</span><br><span class="line">        map.put(<span class="string">&quot;龙门石窟&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">112.484071</span>,<span class="number">34.564375</span>));</span><br><span class="line">        map.put(<span class="string">&quot;老君山&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">111.663</span>,<span class="number">33.75186</span>));</span><br><span class="line">        map.put(<span class="string">&quot;白马寺的公共厕所1&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">112.608311</span>,<span class="number">34.726809</span>));</span><br><span class="line">        map.put(<span class="string">&quot;白马寺的公共厕所2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">112.610356</span>,<span class="number">34.728481</span>));</span><br><span class="line">        redisTemplate.opsForGeo().add(CITY, map);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Point <span class="title function_">position</span><span class="params">(String member)</span> &#123;</span><br><span class="line">        List&lt;Point&gt; position = redisTemplate.opsForGeo().position(CITY, member);</span><br><span class="line">        <span class="keyword">return</span> position.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hash</span><span class="params">(String member)</span> &#123;</span><br><span class="line">        List&lt;String&gt; hash = redisTemplate.opsForGeo().hash(CITY, member);</span><br><span class="line">        <span class="keyword">return</span> hash.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Distance <span class="title function_">distance</span><span class="params">(String member1, String member2)</span> &#123;</span><br><span class="line">        <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> redisTemplate.opsForGeo().distance(CITY, member1, member2,</span><br><span class="line">                RedisGeoCommands.DistanceUnit.KILOMETERS);</span><br><span class="line">        <span class="keyword">return</span> distance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GeoResults <span class="title function_">radiusByxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(<span class="number">112.610356</span>, <span class="number">34.728481</span>, Metrics.KILOMETERS.getMultiplier());</span><br><span class="line">        RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().includeCoordinates().sortDescending().limit(<span class="number">50</span>);</span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; geoResults = redisTemplate.opsForGeo().radius(CITY, circle, args);</span><br><span class="line">        <span class="keyword">return</span> geoResults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GeoResults <span class="title function_">radiusMember</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> <span class="string">&quot;白马寺&quot;</span>;</span><br><span class="line">        RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().includeDistance().sortAscending().limit(<span class="number">10</span>);</span><br><span class="line">        <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">10</span>, Metrics.KILOMETERS);</span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; geoResults = redisTemplate.opsForGeo().radius(CITY, member, distance, args);</span><br><span class="line">        <span class="keyword">return</span> geoResults;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeoController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GeoService geoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/geoadd&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">geoAdd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.geoAdd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/geopos&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> Point <span class="title function_">position</span><span class="params">(String member)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.position(member);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/geohash&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hash</span><span class="params">(String member)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.hash(member);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/geodist&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> Distance <span class="title function_">distance</span><span class="params">(String member1, String member2)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.distance(member1,member2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/georadius&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> GeoResults <span class="title function_">radiusByxy</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.radiusByxy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/georadiusByMember&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> GeoResults <span class="title function_">radiusMember</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.radiusMember();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第十五节布隆过滤器"><a href="#第十五节布隆过滤器" class="headerlink" title="第十五节	布隆过滤器"></a>第十五节	布隆过滤器</h2><h3 id="15-1BitMap"><a href="#15-1BitMap" class="headerlink" title="15.1	BitMap"></a>15.1	BitMap</h3><ul>
<li><p><strong>BitMap</strong>：由 0 和 1 状态表现得二进制位的 <strong>bit</strong> 数组</p>
</li>
<li><p><strong>BitMap 的作用</strong>：用于状态统计，签到统计等</p>
</li>
<li><p><strong>BitMap 命令</strong></p>
<ul>
<li><p><strong>SETBIT</strong>： 将第 <strong>offse</strong> 的值设为 <strong>value</strong></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setbit key offset value</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GETBIT</strong>：获得第 <strong>offset</strong> 位的值</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getbit key offset</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>STRLEN</strong>：得出占多少字节，超过8位后自己按照8位一组一 <strong>byte</strong> 再扩容</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>BITCOUNT</strong>：得出该 <strong>key</strong> 里面含有几个1</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitcount key</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>BITOP</strong>： 对一个或多个 <strong>key</strong> 求逻辑运算，并将结果保存到 <strong>destkey</strong> </p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bitop and destkey k1 k2</span><br><span class="line">bitop or destkey k1 k2</span><br><span class="line">bitop xor destkey k1 k2</span><br><span class="line">bitop not destkey k1 k2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="15-2布隆过滤器"><a href="#15-2布隆过滤器" class="headerlink" title="15.2	布隆过滤器"></a>15.2	布隆过滤器</h3><ul>
<li><p><strong>布隆过滤器</strong>：由一个初值都为零的 <strong>bit</strong> 数组和多个哈希函数构成，用来快速判断集合中是否存在某个元素</p>
<ul>
<li><strong>目的</strong>：减少内存占用</li>
<li><strong>方式</strong>：不保存数据信息，只是在内存中做一个是否存在的标记 <strong>flag</strong></li>
<li><strong>本质</strong>：判断具体数据是否村在于一个大的集合中</li>
</ul>
</li>
<li><p><strong>布隆过滤器的作用</strong></p>
<ul>
<li>高效地插入和查询，占用空间少，返回地结果是不确定性 + 不完美性</li>
<li>一个元素如果判断结果：存在时，元素不一定存在，不存在时，元素一定不存在</li>
<li>布隆过滤器可以添加元素，但是不能删除元素</li>
</ul>
</li>
<li><p><strong>布隆过滤器使用步骤</strong></p>
<ul>
<li>由长度为 <strong>m</strong> 的位向量或位列表 （仅包含 0 或 1 位值的列表）组成，最初所有的值均设置为 0</li>
<li>添加数据，为了尽量地址不冲突，使用多个 <strong>hash</strong> 函数对 <strong>key</strong> 进行运算，算得一个下标索引值，然后对数据长度进行取模运算得到一个位置，每个 <strong>hash</strong> 函数都会算得一个不同的位置，再把位数组的这几个位置都置为 1 就完成了 <strong>add</strong> 操作</li>
<li>向布隆过滤器查询某个 <strong>key</strong> 是否存在时，先把这个 <strong>key</strong> 通过相同的多个 <strong>hash</strong> 函数进行运算，查看对应的位置是否都为 1，只要有一个位为零，那么说明布隆过滤器中这个 <strong>key</strong> 不存在</li>
</ul>
</li>
<li><p><strong>手写布隆过滤器</strong></p>
<ul>
<li><p>初始化</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomFilterInit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;customer:11&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashValue</span> <span class="operator">=</span> Math.abs(key.hashCode());</span><br><span class="line">        <span class="type">long</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">long</span>) (hashValue % Math.pow(<span class="number">2</span>, <span class="number">32</span>));</span><br><span class="line">        log.info(key + <span class="string">&quot;对应的坑位 index： &#123;&#125;&quot;</span>, index);</span><br><span class="line">        redisTemplate.opsForValue().setBit(<span class="string">&quot;whitelistCustomer&quot;</span>, index, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>工具类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckUtils</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkWithBloomFilter</span><span class="params">(String checkItem, String key)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashValue</span> <span class="operator">=</span> Math.abs(key.hashCode());</span><br><span class="line">        <span class="type">long</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">long</span>) (hashValue % Math.pow(<span class="number">2</span>, <span class="number">32</span>));</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">existOK</span> <span class="operator">=</span> redisTemplate.opsForValue().getBit(checkItem, index);</span><br><span class="line">        log.info(<span class="string">&quot;----&gt;:&quot;</span> + key +<span class="string">&quot;对应坑位下标index：&quot;</span>+ index + <span class="string">&quot;是否存在：&quot;</span> + existOK);</span><br><span class="line">        <span class="keyword">return</span> existOK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_CUSTOMER</span> <span class="operator">=</span> <span class="string">&quot;customer:&quot;</span>;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomerMapper customerMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CheckUtils checkUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">findCustomerByIdWithBloomFilter</span><span class="params">(Integer customerId)</span> &#123;</span><br><span class="line">        <span class="type">Customer</span> <span class="variable">customer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_KEY_CUSTOMER + customerId;</span><br><span class="line">        <span class="keyword">if</span> (!checkUtils.checkWithBloomFilter(<span class="string">&quot;whitelistCustomer&quot;</span>, key)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;白名单没有此信息，不可以访问&quot;</span> + key);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        customer = (Customer) redisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (customer == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (CustomerService.class) &#123;</span><br><span class="line">                customer = (Customer) redisTemplate.opsForValue().get(key);</span><br><span class="line">                <span class="keyword">if</span> (customer == <span class="literal">null</span>) &#123;</span><br><span class="line">                    customer = customerMapper.selectByPrimaryKey(customerId);</span><br><span class="line">                    <span class="keyword">if</span> (customer == <span class="literal">null</span>) &#123;</span><br><span class="line">                        redisTemplate.opsForValue().set(key, <span class="string">&quot;defaultNull&quot;</span>, <span class="number">7L</span>, TimeUnit.DAYS);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        redisTemplate.opsForValue().set(key, customer, <span class="number">7L</span>, TimeUnit.DAYS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> customer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomerService customerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/customer/add&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCustomer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="type">Customer</span> <span class="variable">customer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Customer</span>();</span><br><span class="line">            customer.setCname(<span class="string">&quot;customer&quot;</span> +i);</span><br><span class="line">            customer.setAge(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">30</span>)+<span class="number">1</span>);</span><br><span class="line">            customer.setPhone(<span class="string">&quot;12345678910&quot;</span>);</span><br><span class="line">            customer.setSex((<span class="type">byte</span>) <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">2</span>));</span><br><span class="line">            customer.setBirth(Date.from(LocalDateTime.now().atZone(ZoneId.systemDefault()).toInstant()));</span><br><span class="line">            customerService.addCustomer(customer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/customer/&#123;customerId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">findCustomerById</span><span class="params">(<span class="meta">@PathVariable(&quot;customerId&quot;)</span> Integer customerId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> customerService.findCustomerById(customerId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/bloomfilter/&#123;customerId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">findCustomerByIdWithBloomFilter</span><span class="params">(<span class="meta">@PathVariable(&quot;customerId&quot;)</span> Integer customerId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> customerService.findCustomerByIdWithBloomFilter(customerId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>Google 布隆过滤器 Guava</strong></p>
<ul>
<li><p>导入依赖</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>23.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuavaBloomFilterService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_1W</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIZE</span> <span class="operator">=</span> <span class="number">100</span> * _1W;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="variable">fpp</span> <span class="operator">=</span> <span class="number">0.01</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BloomFilter&lt;Integer&gt; bloomFilter = BloomFilter.create(Funnels.integerFunnel(), SIZE, fpp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">guavaBloomFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; SIZE; i++) &#123;</span><br><span class="line">            bloomFilter.put(i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第十六节缓存"><a href="#第十六节缓存" class="headerlink" title="第十六节	缓存"></a>第十六节	缓存</h2><h3 id="16-1缓存预热"><a href="#16-1缓存预热" class="headerlink" title="16.1	缓存预热"></a>16.1	缓存预热</h3><ul>
<li><p><strong>缓存预热</strong>：缓存预热就是系统上线后，提前将相关的缓存数据直接加载到缓存系统，避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题，用户直接查询事先被预热的缓存数据</p>
</li>
<li><p><strong>缓存预热的解决方法</strong>：使用 <strong>@PostConstruct</strong> 初始化白名单数据</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;HashMap&gt; list = telDao.getList();</span><br><span class="line">    <span class="keyword">for</span> (HashMap map:list)&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(map.get(<span class="string">&quot;id&quot;</span>).toString(),map.get(<span class="string">&quot;tel&quot;</span>).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="16-2缓存雪崩"><a href="#16-2缓存雪崩" class="headerlink" title="16.2	缓存雪崩"></a>16.2	缓存雪崩</h3><ul>
<li><strong>缓存雪崩</strong>：缓存雪崩就是瞬间过期数据量太大，导致对数据库服务器造成压力</li>
<li><strong>缓存雪崩的发生情况</strong><ul>
<li><strong>redis</strong> 主机挂了， <strong>redis</strong> 全盘崩溃，偏硬件运维</li>
<li><strong>redis</strong> 中有大量 <strong>key</strong> 同时过期大面积失效，偏软件开发</li>
</ul>
</li>
<li><strong>缓存雪崩解决方法</strong><ul>
<li><strong>redis</strong> 中 <strong>key</strong> 设置为永不过期或者过期时间错开</li>
<li><strong>redis</strong> 缓存集群实现高可用<ul>
<li>主从 + 哨兵</li>
<li><strong>redis</strong> 集群</li>
<li>开启 <strong>redis</strong> 持久化机制 <strong>aof</strong> &#x2F; <strong>rdb</strong>，尽快恢复缓存集群</li>
</ul>
</li>
<li>多缓存结合预防雪崩，<strong>ehcache</strong> 本地缓存 + <strong>redis</strong> 缓存</li>
<li>服务降级，<strong>Hystrix</strong> 或者 <strong>sentinel</strong> 限流降级</li>
</ul>
</li>
</ul>
<h3 id="16-3缓存穿透"><a href="#16-3缓存穿透" class="headerlink" title="16.3	缓存穿透"></a>16.3	缓存穿透</h3><ul>
<li><strong>缓存穿透</strong>：请求去查询一条数据，先查 <strong>redis</strong>，<strong>redis</strong> 里面没有，再查 <strong>mysql</strong>，<strong>mysql</strong> 里面无，都查询不到该条记录，但是请求每次都会打到数据库上面去，导致后台数据库压力暴增</li>
<li><strong>缓存穿透解决方法</strong><ul>
<li>空对象缓存或者缺省值</li>
<li>布隆过滤器设置白名单</li>
</ul>
</li>
</ul>
<h3 id="16-4缓存击穿"><a href="#16-4缓存击穿" class="headerlink" title="16.4	缓存击穿"></a>16.4	缓存击穿</h3><ul>
<li><p><strong>缓存击穿</strong>：大量请求同时查询一个 <strong>key</strong> 时，此时这个 <strong>key</strong> 正好失效了，就会导致大量的请求都打到数据库上面去，也就是热点 <strong>key</strong> 突然都失效了，<strong>MySQL</strong> 承受高并发量</p>
</li>
<li><p><strong>缓存击穿解决方法</strong></p>
<ul>
<li>差异失效时间，对于访问频繁的热点 <strong>key</strong>，不设置过期时间</li>
<li>互斥更新，采用双检加锁</li>
</ul>
</li>
<li><p><strong>缓存击穿案例</strong></p>
<ul>
<li><p>服务层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JHSTaskService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JHS_KEY</span> <span class="operator">=</span> <span class="string">&quot;jhs&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JHS_KEY_A</span> <span class="operator">=</span> <span class="string">&quot;jhs:a&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JHS_KEY_B</span> <span class="operator">=</span> <span class="string">&quot;jhs:b&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initJHSAB</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                List&lt;Product&gt; list = <span class="built_in">this</span>.getProductsFromMysql();</span><br><span class="line">                </span><br><span class="line">                redisTemplate.delete(JHS_KEY_B);</span><br><span class="line">                redisTemplate.opsForList().leftPushAll(JHS_KEY_B, list);</span><br><span class="line">                redisTemplate.expire(JHS_KEY_B, <span class="number">86410L</span>, TimeUnit.SECONDS);</span><br><span class="line">                </span><br><span class="line">                redisTemplate.delete(JHS_KEY_A);</span><br><span class="line">                redisTemplate.opsForList().leftPushAll(JHS_KEY_A, list);</span><br><span class="line">                redisTemplate.expire(JHS_KEY_A, <span class="number">86400L</span>, TimeUnit.SECONDS);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MINUTES.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JHSProductController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JHS_KEY</span> <span class="operator">=</span> <span class="string">&quot;jhs&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JHS_KEY_A</span> <span class="operator">=</span> <span class="string">&quot;jhs:a&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JHS_KEY_B</span> <span class="operator">=</span> <span class="string">&quot;jhs:b&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/product/findAB&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Product&gt; <span class="title function_">findAB</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        List&lt;Product&gt; list = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> (page - <span class="number">1</span>) * size;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> start + size - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            list = redisTemplate.opsForList().range(JHS_KEY_A, start, end);</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isEmpty(list)) &#123;</span><br><span class="line">                <span class="comment">// A没有来找B</span></span><br><span class="line">                list = redisTemplate.opsForList().range(JHS_KEY_B, start, end);</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isEmpty(list))&#123;</span><br><span class="line">                    <span class="comment">// TODO 走mysql查询</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 。。。重试机制 再次查询mysql</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第十七节分布式锁"><a href="#第十七节分布式锁" class="headerlink" title="第十七节	分布式锁"></a>第十七节	分布式锁</h2><h3 id="17-1分布式锁"><a href="#17-1分布式锁" class="headerlink" title="17.1	分布式锁"></a>17.1	分布式锁</h3><ul>
<li><strong>分布式锁的特性</strong><ul>
<li><strong>独占性</strong>：任何时刻有且只有一个线程持有这个锁</li>
<li><strong>高可用</strong><ul>
<li>若 <strong>redis</strong> 集群环境下，不能因为某一个节点挂了而出现获取锁和释放锁失败的情况</li>
<li>高并发请求下，依旧性能很好</li>
</ul>
</li>
<li><strong>防死锁</strong>：不能出现死锁问题，必须有超时重试机制或者撤销操作，有个终止跳出的途径</li>
<li><strong>不乱抢</strong>：防止张冠李戴，只能解锁自己的锁，不能把别人的锁给释放了</li>
<li><strong>重入性</strong>：同一节点的同一线程如果获得锁之后，他可以再次获取这个锁</li>
</ul>
</li>
</ul>
<h3 id="17-2分布式锁的实现"><a href="#17-2分布式锁的实现" class="headerlink" title="17.2	分布式锁的实现"></a>17.2	分布式锁的实现</h3><ul>
<li><p><strong>购物场景案例</strong></p>
<ul>
<li><p>配置类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Serializable&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory connectionFactory)</span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Serializable&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/buy_goods&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buy_Goods</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;goods:001&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">goodsNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retStr</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (goodsNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">realNumber</span> <span class="operator">=</span> goodsNumber - <span class="number">1</span>;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;goods:001&quot;</span>, realNumber + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            retStr = <span class="string">&quot;你已经成功秒杀商品，此时还剩余：&quot;</span> + realNumber + <span class="string">&quot;件&quot;</span> + <span class="string">&quot;\t 服务器端口: &quot;</span> + serverPort;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retStr = <span class="string">&quot;商品已经售罄/活动结束/调用超时，欢迎下次光临&quot;</span> + <span class="string">&quot;\t 服务器端口: &quot;</span> + serverPort;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>案例升级</strong></p>
<ul>
<li><p><strong>单机版加锁</strong>：防止在高并发情况下库存不准</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 nginx，使用 setnx 命令</strong>：分布式锁，防止超卖现象</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;xfcyRedisLock&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID() + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!stringRedisTemplate.opsForValue().setIfAbsent(key, value)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">20</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>设置过期时间</strong>：防止服务器宕机无法成功释放分布式锁</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;xfcyRedisLock&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID() + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!stringRedisTemplate.opsForValue().setIfAbsent(key, value)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">20</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stringRedisTemplate.expire(key, <span class="number">30L</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>合并加锁和设置过期时间</strong>：使操作具备原子性</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;xfcyRedisLock&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID() + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!stringRedisTemplate.opsForValue().setIfAbsent(key, value, <span class="number">30L</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">20</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判断锁所属线程</strong>：防止误删其他线程的锁</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;xfcyRedisLock&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID() + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line">    <span class="keyword">while</span> (!stringRedisTemplate.opsForValue().setIfAbsent(key, value, <span class="number">30L</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">20</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stringRedisTemplate.opsForValue().get(key).equalsIgnoreCase(value)) &#123;</span><br><span class="line">            stringRedisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 Lua 脚本</strong>：使判断操作和删除操作具备原子性</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;xfcyRedisLock&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID() + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line">    <span class="keyword">while</span> (!stringRedisTemplate.opsForValue().setIfAbsent(key, value, <span class="number">30L</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">20</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">luaScript</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if (redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1]) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(luaScript, Boolean.class), Arrays.asList(key), value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 hash 类型的锁，引入工厂模式</strong>：实现锁的可重入性，实现锁的过期时间自动续期</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedLockFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">    redisLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">        <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">            retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> String uuidValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLockFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = IdUtil.simpleUUID();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lock <span class="title function_">getDistributedLock</span><span class="params">(String lockType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lockType == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;REDIS&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.lockName = <span class="string">&quot;xfcyRedisLock&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate, lockName, uuidValue);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;ZOOKEEPER&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.lockName = <span class="string">&quot;xfcyZookeeperLock&quot;</span>;</span><br><span class="line">            <span class="comment">// TODO zoookeeper 版本的分布式锁</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;MYSQL&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">this</span>.lockName = <span class="string">&quot;xfcyMysqlLock&quot;</span>;</span><br><span class="line">            <span class="comment">// TODO MYSQL 版本的分布式锁</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String lockName;    <span class="comment">// KEYS[1]</span></span><br><span class="line">    <span class="keyword">private</span> String uuidValue;   <span class="comment">// ARGV[1]</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> expireTime;    <span class="comment">// ARGV[2]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName, String uuidValue)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = uuidValue + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        tryLock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tryLock(-<span class="number">1L</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (time == -<span class="number">1L</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1)  &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span> (!stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">60</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            resetExpire();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return nil &quot;</span> +</span><br><span class="line">                <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then  &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                <span class="string">&quot;else  &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == flag) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;this lock doesn&#x27;t exists0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetExpire</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) &#123;</span><br><span class="line">                    resetExpire();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, (<span class="built_in">this</span>.expireTime * <span class="number">1000</span>) / <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="第十八节Redlock算法和Redisson的使用"><a href="#第十八节Redlock算法和Redisson的使用" class="headerlink" title="第十八节	Redlock算法和Redisson的使用"></a>第十八节	Redlock算法和Redisson的使用</h2><h3 id="18-1Redlock红锁算法"><a href="#18-1Redlock红锁算法" class="headerlink" title="18.1	Redlock红锁算法"></a>18.1	Redlock红锁算法</h3><ul>
<li><strong>解决单点故障问题</strong><ul>
<li><strong>Redis</strong> 提供了 <strong>Redlock</strong> 算法，用来实现基于多个实例的分布式锁</li>
<li>锁变量由多个实例维护，即使有实例发生了故障，锁变量仍然是存在的，客户端还是可以完成锁操作</li>
<li><strong>Redlock</strong> 算法是实现高可靠分布式锁的一种有效解决方案，可以在实际开发中使用</li>
</ul>
</li>
<li><strong>设计理念</strong><ul>
<li>依次尝试从5个实例，使用相同的 <strong>key</strong> 和随机值获取锁，当向 <strong>Redis</strong> 请求获取锁时，客户端应该设置一个超时时间，这个超时时间应该小于锁的失效时间，这样可以防止客户端在试图与一个宕机的 <strong>Redis</strong> 节点对话时长时间处于阻塞状态，如果一个实例不可用，客户端应该尽快尝试去另外一个 <strong>Redis</strong> 实例请求获取锁</li>
<li>客户端通过当前时间减去步骤 1 记录的时间来计算获取锁使用的时间，当且仅当从大多数 N&#x2F;2+1 的 <strong>Redis</strong> 节点都取到锁，并且获取锁使用的时间小于锁失效时间时，锁才算获取成功</li>
<li>如果取到了锁，其真正有效时间等于初始有效时间减去获取锁所使用的时间</li>
<li>如果由于某些原因未能获得锁，客户端应该在所有的 <strong>Redis</strong> 实例上进行解锁</li>
</ul>
</li>
</ul>
<h3 id="18-2红锁使用案例"><a href="#18-2红锁使用案例" class="headerlink" title="18.2	红锁使用案例"></a>18.2	红锁使用案例</h3><ul>
<li><p><strong>使用 Redisson 对象</strong></p>
<ul>
<li><p>引入依赖</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span>&#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Redisson <span class="title function_">redisson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">                .setAddress(<span class="string">&quot;redis://192.168.238.111:6379&quot;</span>)</span><br><span class="line">                .setDatabase(<span class="number">0</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (Redisson) Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvetoryController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> InventoryService inventoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/inventory/sale&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inventoryService.sale();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/inventory/saleByRedisson&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">saleByRedisson</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inventoryService.saleByRedisson();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Redisson redisson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">saleByRedisson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redissonLock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;xfcyRedisLock&quot;</span>);</span><br><span class="line">        redissonLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (redissonLock.isLocked() &amp;&amp; redissonLock.isHeldByCurrentThread())&#123;</span><br><span class="line">                redissonLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>多级部署案例</strong></p>
<ul>
<li><p><strong>Docker</strong> 部署 <strong>Redis</strong></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 6381:6379 --name redis-master-1 -d redis</span><br><span class="line">docker run -p 6382:6379 --name redis-master-2 -d redis</span><br><span class="line">docker run -p 6383:6379 --name redis-master-3 -d redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入 <strong>Redis</strong> 容器</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-master-1 redis-cli</span><br><span class="line">docker exec -it redis-master-2 /bin/bash </span><br><span class="line">docker exec -it redis-master-3 /bin/bash  </span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.redis.password</span>=<span class="string"></span></span><br><span class="line"><span class="attr">spring.redis.timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.redis.mode</span>=<span class="string">single</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.pool.conn-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.redis.pool.so-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.redis.pool.size</span>=<span class="string">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.single.address1</span>=<span class="string">192.168.238.111:6381</span></span><br><span class="line"><span class="attr">spring.redis.single.address2</span>=<span class="string">192.168.238.111:6382</span></span><br><span class="line"><span class="attr">spring.redis.single.address3</span>=<span class="string">192.168.238.111:6383</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisProperties redisProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonClient1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> redisProperties.getSingle().getAddress1();</span><br><span class="line">        node = node.startsWith(<span class="string">&quot;redis://&quot;</span>) ? node : <span class="string">&quot;redis://&quot;</span> + node;</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(node)</span><br><span class="line">                .setTimeout(redisProperties.getPool().getConnTimeout())</span><br><span class="line">                .setConnectionPoolSize(redisProperties.getPool().getSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(redisProperties.getPool().getMinIdle());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(redisProperties.getPassword())) &#123;</span><br><span class="line">            serverConfig.setPassword(redisProperties.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> redisProperties.getSingle().getAddress2();</span><br><span class="line">        node = node.startsWith(<span class="string">&quot;redis://&quot;</span>) ? node : <span class="string">&quot;redis://&quot;</span> + node;</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(node)</span><br><span class="line">                .setTimeout(redisProperties.getPool().getConnTimeout())</span><br><span class="line">                .setConnectionPoolSize(redisProperties.getPool().getSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(redisProperties.getPool().getMinIdle());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(redisProperties.getPassword())) &#123;</span><br><span class="line">            serverConfig.setPassword(redisProperties.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonClient3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> redisProperties.getSingle().getAddress3();</span><br><span class="line">        node = node.startsWith(<span class="string">&quot;redis://&quot;</span>) ? node : <span class="string">&quot;redis://&quot;</span> + node;</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(node)</span><br><span class="line">                .setTimeout(redisProperties.getPool().getConnTimeout())</span><br><span class="line">                .setConnectionPoolSize(redisProperties.getPool().getSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(redisProperties.getPool().getMinIdle());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(redisProperties.getPassword())) &#123;</span><br><span class="line">            serverConfig.setPassword(redisProperties.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置信息类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisPoolProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> minIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxActive;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxWait;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> connTimeout;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> soTimeout;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.redis&quot;, ignoreUnknownFields = false)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> database;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String mode;</span><br><span class="line">    <span class="keyword">private</span> RedisPoolProperties pool;</span><br><span class="line">    <span class="keyword">private</span> RedisSingleProperties single;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSingleProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String address1;</span><br><span class="line">    <span class="keyword">private</span> String address2;</span><br><span class="line">    <span class="keyword">private</span> String address3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务层 + 控制层</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedLockController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_REDLOCK</span> <span class="operator">=</span> <span class="string">&quot;ATGUIGU_REDLOCK&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient1;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient2;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient3;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> isLockBoolean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/multiLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMultiLock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span>  IdUtil.simpleUUID();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuidValue</span> <span class="operator">=</span> uuid+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();</span><br><span class="line"></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient1.getLock(CACHE_KEY_REDLOCK);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(CACHE_KEY_REDLOCK);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(CACHE_KEY_REDLOCK);</span><br><span class="line"></span><br><span class="line">        <span class="type">RedissonMultiLock</span> <span class="variable">redLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedissonMultiLock</span>(lock1, lock2, lock3);</span><br><span class="line">        redLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(uuidValue+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;---come in biz multiLock&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">30</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">            System.out.println(uuidValue+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;---task is over multiLock&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;multiLock task is over  &quot;</span>+uuidValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="18-3缓存淘汰策略"><a href="#18-3缓存淘汰策略" class="headerlink" title="18.3	缓存淘汰策略"></a>18.3	缓存淘汰策略</h3><ul>
<li><p><strong>查看最大占用内存</strong></p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxmemory 0</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查看内存使用情况</strong></p>
<ul>
<li><p>内存信息</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info memory</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看最大内存</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config get maxmemory</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>过期键删除策略</strong></p>
<ul>
<li><p><strong>立即删除</strong>：创建一个定时器，让定时器在该过期时间到来时，立即执行对其进行删除的操作，对 <strong>CPU</strong> 不友好，用处理器性能换取存储空间</p>
</li>
<li><p><strong>惰性删除</strong>：当需要该 <strong>key</strong> 时，再检查其是否过期，对内存不友好，用存储空间换取处理器性能</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lazyfree-lazy-eviction=yes</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>定期删除</strong>：每隔一段时间，我们就对一些 <strong>key</strong> 进行检查，删除里面过期的 <strong>key</strong>，来减少删除操作对 <strong>CPU</strong> 时间的影响</p>
</li>
</ul>
</li>
<li><p><strong>缓存淘汰策略</strong></p>
<ul>
<li><strong>淘汰算法</strong><ul>
<li><strong>LRU</strong>：最近最少使用的页面置换算法，淘汰最长时间未被使用的页面，看页面最后一次被使用到发生调度的时间长短，首先淘汰最长时间未被使用的页面</li>
<li><strong>LFU</strong>：最近最不常用页面置换算法，淘汰一定时期内被访问次数最少的页面，看一定时间段内被访问次数最少的页，看一定时间段内页面被使用的频率，淘汰一定时期内被访问次数最少的页</li>
</ul>
</li>
<li><strong>8种缓存淘汰策略</strong><ul>
<li><strong>noevication</strong> ： 不会驱逐任何 <strong>key</strong>，表示即使内存达到上限也不进行置换，所有能引起内存增加的命令都返回 <strong>error</strong></li>
<li><strong>allkeys-lru</strong>： 对所有 <strong>key</strong> 使用 <strong>LRU</strong> 算法进行删除，优先删除掉最近不经常使用的 <strong>key</strong>，用以保存新数据</li>
<li>**volatie-lru **: 对所有设置了过期时间的 <strong>key</strong> 使用 <strong>LRU</strong> 算法删除</li>
<li><strong>allkeys-random</strong> ：对所有 <strong>key</strong> 随机删除</li>
<li><strong>volatie-random</strong> ： 对所有设置了过期时间的 <strong>key</strong> 随机删除</li>
<li><strong>volatie-ttl</strong>：对所有设置了过期时间的 <strong>key</strong> 随即删除</li>
<li><strong>allkeys-lfu</strong>：对所有 <strong>key</strong> 使用 <strong>LFU</strong> 算法进行删除</li>
<li><strong>volatile-lfu</strong>：对所有设置了过期时间的 <strong>key</strong> 使用 <strong>LFU</strong> 算法进行删除</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="第十九节Redis数据类型源码"><a href="#第十九节Redis数据类型源码" class="headerlink" title="第十九节	Redis数据类型源码"></a>第十九节	Redis数据类型源码</h2><h3 id="19-1Redis架构"><a href="#19-1Redis架构" class="headerlink" title="19.1	Redis架构"></a>19.1	Redis架构</h3><ul>
<li><p><strong>Redis 数据结构</strong></p>
<ul>
<li>简单动态字符串 <strong>sds</strong></li>
<li>整数集合 <strong>intset</strong></li>
<li>压缩列表 <strong>ziplist</strong></li>
<li>快速链表 <strong>quicklist</strong></li>
<li>紧凑列表 <strong>listpack</strong></li>
<li>字典 <strong>dict</strong></li>
</ul>
</li>
<li><p><strong>Redis 数据库的实现</strong>：数据库底层实现 <strong>db.c</strong> 和持久化 <strong>rdb.c</strong> 、<strong>aof.c</strong></p>
</li>
<li><p><strong>Redis 服务端和客户端实现</strong></p>
<ul>
<li>事件驱动 <strong>ae.c</strong> 和 <strong>ae_epoll.c</strong></li>
<li>网络连接 <strong>anet.c 和 networking.c</strong></li>
<li>服务端程序 <strong>server.c</strong></li>
<li>客户端程序 <strong>redis-cli.c</strong></li>
</ul>
</li>
<li><p><strong>Redis KV 数据库键值对</strong>：<strong>redis</strong> 是 <strong>key-value</strong> 存储系统，<strong>key</strong> 一般是 <strong>String</strong> 类型的字符串对象，<strong>value</strong> 类型则为 <strong>redis</strong> 对象，<strong>value</strong> 可以是字符串对象，也可以是集合数据类型的对象，比如 <strong>List</strong> 对象，<strong>Hash</strong> 对象，<strong>set</strong> 对象和 <strong>zset</strong> 对象</p>
</li>
<li><p><strong>Redis 对象</strong>：<strong>redis</strong> 定义了 <strong>redisobject</strong> 结构体来表示 <strong>string</strong>、<strong>hash</strong>、<strong>list</strong>、<strong>set</strong>、<strong>zset</strong> 等数据结构</p>
<ul>
<li><p>哈希表节点</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span>&#123;</span></span><br><span class="line">    <span class="type">void</span> *key; <span class="comment">// 指向 String 对象</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="type">void</span> *val;</span><br><span class="line">        <span class="type">uint64_t</span> u64;</span><br><span class="line">        <span class="type">int64_t</span> s64;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">    &#125; v; <span class="comment">// 指向 value 对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">void</span> *metadata[];</span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Redis</strong> 对象</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span>&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> type:<span class="number">4</span>; <span class="comment">// 对象类型</span></span><br><span class="line">    <span class="type">unsigned</span> encoding:<span class="number">4</span>; <span class="comment">// 具体的数据结构</span></span><br><span class="line">    <span class="type">unsigned</span> lru:LRU_BITS; <span class="comment">// 24位，记录最后一次被命令访问的时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> refcount; <span class="comment">// 引用计数，用于垃圾计数</span></span><br><span class="line">    <span class="type">void</span> *ptr; <span class="comment">// 指向对象的数据结构</span></span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>返回 Redis 对象信息</strong></p>
<ul>
<li><p>开启 <strong>Debug</strong> 命令</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enable-debug-command local</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回对象信息</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG OBJECT k1</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="19-2五大数据类型源码"><a href="#19-2五大数据类型源码" class="headerlink" title="19.2	五大数据类型源码"></a>19.2	五大数据类型源码</h3><ul>
<li><strong>动态字符串 SDS</strong><ul>
<li><strong>int len</strong>：已用的字节长度</li>
<li><strong>int alloc</strong>：字符串的最大字节长度</li>
<li><strong>char flags</strong>：表示动态字符串的类型</li>
<li>**char buf[]**：真正有效的字符串数据</li>
</ul>
</li>
<li><strong>String 数据类型</strong><ul>
<li><strong>int</strong>：保存 <strong>long</strong> 型的64位有符号整数，只有整数才会使用 <strong>int</strong>，<strong>Redis</strong> 启动时会预先建立 10000 个分别存储 0~9999 的 <strong>redisObject</strong> 变量作为共享对象，节省了指针的空间开销</li>
<li><strong>embstr</strong>：代表 <strong>embstr</strong> 格式的简单动态字符串，保存长度小于44字节的字符串，只分配一块连续的内存空间，空间中依次包含 <strong>redisObject</strong> 与 <strong>sdshdr</strong> 两个数据结构，让元数据、指针和 <strong>SDS</strong> 是一块连续的内存区域，这样就可以避免内存碎片</li>
<li><strong>raw</strong>：保存长度大于44字节的字符串，调用两次内存分配函数，分配两块内存空间，一块用于包含 <strong>redisObject</strong> 结构，而另一块用于包含 <strong>sdshdr</strong> 结构</li>
</ul>
</li>
<li><strong>Hash 数据类型</strong><ul>
<li><strong>压缩列表 ziplist</strong><ul>
<li>键的字段个数小于 <strong>hash-max-ziplist-entries</strong> 并且每个字段名和字段值的长度小于 <strong>hash-max-ziplist-value</strong></li>
<li>一个经过特殊编码的双向链表，不存储指向前一个链表节点 <strong>prev</strong> 和指向下一个链表节点的指针 <strong>next</strong> 而是存储上一个节点长度和当前节点长度，通过牺牲部分读写性能，来换取高效的内存空间利用率，节约内存，只用在字段个数少，字段值小的场景里面</li>
</ul>
</li>
<li><strong>哈希表 hashtable</strong><ul>
<li>每个键值对都会有一个 <strong>dictEntry</strong></li>
<li>底层真正的散列表数据结构是一层层嵌套下去，使用数组 + 链表的数据结构</li>
</ul>
</li>
<li><strong>紧凑列表 packlist</strong><ul>
<li>哈希对象保存的键值对数量小于 512 个，所有的键值对的健和值的字符串长度都小于等于 64 <strong>byte</strong>，在 <strong>Redis7</strong> 中替代 <strong>ziplist</strong></li>
<li>使用 <strong>prevlen</strong> 字段记录前一个节点的长度，该字段空间大小与前一个节点长度有关</li>
<li><strong>packlist</strong> 解决了 <strong>ziplist</strong> 的连锁更新问题</li>
</ul>
</li>
</ul>
</li>
<li><strong>List 数据类型</strong><ul>
<li><strong>快速链表 quicklist</strong><ul>
<li>是 <strong>zipList</strong> 和 <strong>linkedList</strong> 的混合体，它将 <strong>linkedList</strong> 按段切分，每一段使用 <strong>zipList</strong> 来紧凑存储，多个 <strong>zipList</strong> 之间使用双向指针串接起来</li>
<li><strong>redis6</strong> 底层是 <strong>ziplist</strong>，<strong>redis7</strong> 底层是 <strong>listpack</strong></li>
</ul>
</li>
</ul>
</li>
<li><strong>Set 数据类型</strong><ul>
<li><strong>intset</strong><ul>
<li>如果元素都是整数类型且元素个数小于 <strong>set-max-intset-entries</strong>，就用 <strong>intset</strong> 存储</li>
</ul>
</li>
<li><strong>hashset</strong><ul>
<li>如果不是整数类型，就用 <strong>hashtable</strong>，<strong>key</strong> 就是元素的值，<strong>value</strong> 为 <strong>null</strong></li>
</ul>
</li>
</ul>
</li>
<li><strong>ZSet 数据类型</strong><ul>
<li><strong>ziplist</strong><ul>
<li><strong>Redis6</strong> 以及以前版本使用</li>
</ul>
</li>
<li><strong>skiplist</strong><ul>
<li>当有序集合中包含的元素数量超过服务器属性 <strong>server.zset_max_ziplist_entries</strong> 的值，或者有序集合中新添加元素的 <strong>member</strong> 的长度大于服务器属性 <strong>server.zset_max_ziplist_value</strong> 的值时<strong>，redis</strong> 会使用跳表作为有序集合的底层实现</li>
<li>其根本思想是二分查找的思想，对有序链表建立一级索引，每两个节点提取一个节点到索引层，在第一级索引的基础上，每两个节点抽出一个节点到第二级索引，重复构成链表加多级索引的结构</li>
</ul>
</li>
<li><strong>listpack</strong><ul>
<li><strong>Redis7</strong> 引入来替代 <strong>ziplist</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="第二十节IO多路复用"><a href="#第二十节IO多路复用" class="headerlink" title="第二十节	IO多路复用"></a>第二十节	IO多路复用</h2><h3 id="20-1Redis多并发连接"><a href="#20-1Redis多并发连接" class="headerlink" title="20.1	Redis多并发连接"></a>20.1	Redis多并发连接</h3><ul>
<li><strong>Redis 实现多路复用</strong>：采用 <strong>Reactor</strong> 的方式来实现文件事件处理器<ul>
<li>多个套接字（<strong>socket</strong> 连接）</li>
<li><strong>IO</strong> 多路复用程序</li>
<li>文件事件分派器</li>
<li>事件处理器</li>
</ul>
</li>
<li><strong>IO 处理模式</strong><ul>
<li><strong>同步</strong>：调用者要一直等待调用结果的通知后才能进行后续的执行</li>
<li><strong>异步</strong>：指被调用方先返回应答让调用者先回去，然后再计算调用结果，计算完最终结果后再通知并返回给调用方，异步调用要想获得结果一般通过回调</li>
<li><strong>阻塞</strong>：调用方一直在等待而且别的事情什么都不做，当前线&#x2F;进程都会被挂起，啥也不干</li>
<li><strong>非阻塞</strong>：调用在发出去后，调用方先去忙别的事情，不会阻塞当前进&#x2F;线程，而会立即返回</li>
</ul>
</li>
</ul>
<h3 id="20-2BIO"><a href="#20-2BIO" class="headerlink" title="20.2	BIO"></a>20.2	BIO</h3><ul>
<li><p><strong>Java 模拟 BIO</strong></p>
<ul>
<li><p><strong>Redis</strong> 服务端</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServerBIOMultiThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();   <span class="comment">// 阻塞1，等待客户端连接</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">lenth</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">while</span> ((lenth = inputStream.read(bytes)) != -<span class="number">1</span>) &#123;  <span class="comment">// 阻塞2  等待客户端发送数据</span></span><br><span class="line">                        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, lenth));</span><br><span class="line">                    &#125;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, Thread.currentThread().getName()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Redis</strong> 客户端</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient01</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sc.next();</span><br><span class="line">            <span class="keyword">if</span> (str.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.getOutputStream().write(str.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sc.next();</span><br><span class="line">            <span class="keyword">if</span> (str.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.getOutputStream().write(str.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>存在的问题</strong>：每来一个客户端，就要开辟一个线程，如果来1万个客户端，那就要开辟1万个线程，在操作系统中用户态不能直接开辟线程，需要调用内核来创建的一个线程，这其中还涉及到用户状态的切换（上下文的切换），十分消耗资源</p>
</li>
</ul>
<h3 id="20-3NIO"><a href="#20-3NIO" class="headerlink" title="20.3	NIO"></a>20.3	NIO</h3><ul>
<li><p><strong>Java 模拟 NIO</strong></p>
<ul>
<li><p><strong>Redis</strong> 服务端</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServerNIO</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> ArrayList&lt;SocketChannel&gt; socketList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocket</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverSocket.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>));</span><br><span class="line">        serverSocket.configureBlocking(<span class="literal">false</span>);<span class="comment">//设置为非阻塞模式</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (SocketChannel element : socketList) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> element.read(byteBuffer);</span><br><span class="line">                <span class="keyword">if</span> (read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    byteBuffer.flip();</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[read];</span><br><span class="line">                    byteBuffer.get(bytes);</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line">                    byteBuffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            <span class="keyword">if</span> (socketChannel != <span class="literal">null</span>) &#123;</span><br><span class="line">                socketChannel.configureBlocking(<span class="literal">false</span>);<span class="comment">//设置为非阻塞模式</span></span><br><span class="line">                socketList.add(socketChannel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Redis</strong> 客户端</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sc.next();</span><br><span class="line">            <span class="keyword">if</span> (str.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.getOutputStream().write(str.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sc.next();</span><br><span class="line">            <span class="keyword">if</span> (str.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.getOutputStream().write(str.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>存在的问题</strong>：如何用单线程处理大量的链接</p>
</li>
</ul>
<h3 id="20-4IO多路复用"><a href="#20-4IO多路复用" class="headerlink" title="20.4	IO多路复用"></a>20.4	IO多路复用</h3><ul>
<li><strong>Reactor 设计模式</strong>：基于 <strong>I&#x2F;O</strong> 复用模型，多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。当某条连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理<ul>
<li><strong>Reactor</strong>：在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对 <strong>IO</strong> 事件做出反应。 它就像公司的电话接线员，它接听来自客户的电话并将线路转移到适当的联系人</li>
<li><strong>Handlers</strong>：处理程序执行 <strong>IO</strong> 事件要完成的实际事件，类似于客户想要与之交谈的公司中的实际办理人，<strong>Reactor</strong> 通过调度适当的处理程序来响应 <strong>IO</strong> 事件，处理程序执行非阻塞操作</li>
</ul>
</li>
<li><strong>select 方法</strong><ul>
<li><strong>select</strong> 是一个阻塞函数，当没有数据时，会一直阻塞在 <strong>select</strong> 那一行</li>
<li>当有数据时会将 <strong>reset</strong> 中对应的那一位置为1</li>
<li><strong>select</strong> 函数返回，不再阻塞</li>
<li>遍历文件描述符数组，判断哪个 <strong>fd</strong> 被置位了</li>
<li>读取数据，然后处理</li>
</ul>
</li>
<li><strong>select 的缺点</strong><ul>
<li><strong>bitmap</strong> 最大1024位，一个进程最多只能处理1024个客户端</li>
<li>文件描述符数组拷贝到了内核态，仍然有开销</li>
<li><strong>select</strong> 并没有通知用户态哪一个 <strong>socket</strong> 有数据，需要 <strong>O(n)</strong> 的遍历</li>
</ul>
</li>
<li><strong>poll 方法</strong><ul>
<li>将五个 <strong>fd</strong> 从用户态拷贝到内核态</li>
<li><strong>poll</strong> 为阻塞方法，执行 <strong>poll</strong> 方法，如果有数据会将 <strong>fd</strong> 对应的 <strong>revents</strong> 置为 <strong>POLLIN</strong></li>
<li><strong>poll</strong> 方法返回</li>
<li>循环遍历，查看哪个 <strong>fd</strong> 被置位为 <strong>POLLIN</strong> 了</li>
<li>将 <strong>revents</strong> 重置为0，便于复用</li>
<li>对置位的 <strong>fd</strong> 进行读取和处理</li>
</ul>
</li>
<li><strong>poll 的优缺点</strong><ul>
<li><strong>优点</strong><ul>
<li><strong>poll</strong> 使用 <strong>pollfd</strong> 数组来代替 <strong>select</strong> 中的 <strong>bitmap</strong>，数组没有1024的限制，可以一次管理更多的 <strong>client</strong></li>
<li>当 <strong>pollfds</strong> 数组中有事件发生，相应的 <strong>revents</strong> 置位为1，遍历的时候又置位回零，实现了 <strong>pollfd</strong> 数组的重用</li>
</ul>
</li>
<li><strong>缺点</strong>：仍然需要 <strong>O(n)</strong> 的遍历</li>
</ul>
</li>
<li><strong>epoll 方法</strong><ul>
<li>当有数据的时候，会把相应的文件描述符置位，但是 <strong>epoll</strong> 没有 <strong>revent</strong> 标志位，所以并不是真正的置位，这时候会把有数据的文件描述符放到队首</li>
<li><strong>epoll</strong> 会返回有数据的文件描述符的个数</li>
<li>根据返回的个数，读取前N个文件描述符即可</li>
<li>读取、处理</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">huzzsea</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/06/06/Redis/">http://example.com/2024/06/06/Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">huzzsea</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/11/Shell/" title="Shell"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Shell</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/29/Python/" title="Python"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">huzzsea</div><div class="author-info__description">心有所向，无问东西</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82%E5%85%A5%E9%97%A8%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">第一节	入门概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">第二节	数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.1.</span> <span class="toc-text">2.1	数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">2.2.</span> <span class="toc-text">2.2	字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E5%88%97%E8%A1%A8"><span class="toc-number">2.3.</span> <span class="toc-text">2.3	列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="toc-number">2.4.</span> <span class="toc-text">2.4	哈希表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E9%9B%86%E5%90%88"><span class="toc-number">2.5.</span> <span class="toc-text">2.5	集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88"><span class="toc-number">2.6.</span> <span class="toc-text">2.6	有序集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7%E4%BD%8D%E5%9B%BE"><span class="toc-number">2.7.</span> <span class="toc-text">2.7	位图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8%E5%9F%BA%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.8.</span> <span class="toc-text">2.8	基数统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4"><span class="toc-number">2.9.</span> <span class="toc-text">2.9	地理空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10%E6%B5%81"><span class="toc-number">2.10.</span> <span class="toc-text">2.10	流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11%E4%BD%8D%E5%9F%9F"><span class="toc-number">2.11.</span> <span class="toc-text">2.11	位域</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">第三节	持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1RDB"><span class="toc-number">3.1.</span> <span class="toc-text">3.1	RDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2AOF"><span class="toc-number">3.2.</span> <span class="toc-text">3.2	AOF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3RDB-AOF%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">3.3	RDB-AOF混合持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%E7%BA%AF%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.</span> <span class="toc-text">3.4	纯缓存模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">第四节	事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E4%BA%8B%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.</span> <span class="toc-text">4.1	事务介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E4%BA%8B%E5%8A%A1%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">4.2.</span> <span class="toc-text">4.2	事务基本操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E8%8A%82%E7%AE%A1%E9%81%93"><span class="toc-number">5.</span> <span class="toc-text">第五节	管道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%E7%AE%A1%E9%81%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">5.1	管道介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%E7%AE%A1%E9%81%93%E6%93%8D%E4%BD%9C"><span class="toc-number">5.2.</span> <span class="toc-text">5.2	管道操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E8%8A%82%E5%A4%8D%E5%88%B6"><span class="toc-number">6.</span> <span class="toc-text">第六节	复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%E5%A4%8D%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">6.1	复制介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">6.2.</span> <span class="toc-text">6.2	基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">6.3.</span> <span class="toc-text">6.3	复制原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E8%8A%82%E5%93%A8%E5%85%B5"><span class="toc-number">7.</span> <span class="toc-text">第七节	哨兵</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1%E5%93%A8%E5%85%B5%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.</span> <span class="toc-text">7.1	哨兵介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">7.2.</span> <span class="toc-text">7.2	基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3%E5%93%A8%E5%85%B5%E5%8E%9F%E7%90%86"><span class="toc-number">7.3.</span> <span class="toc-text">7.3	哨兵原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E8%8A%82%E9%9B%86%E7%BE%A4"><span class="toc-number">8.</span> <span class="toc-text">第八节	集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E9%9B%86%E7%BE%A4%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.1.</span> <span class="toc-text">8.1	集群介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-number">8.2.</span> <span class="toc-text">8.2	集群分布式存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">8.3.</span> <span class="toc-text">8.3	集群配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E8%8A%82SpringBoot%E9%9B%86%E6%88%90Redis"><span class="toc-number">9.</span> <span class="toc-text">第九节	SpringBoot集成Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1Redis%E9%85%8D%E7%BD%AE"><span class="toc-number">9.1.</span> <span class="toc-text">9.1	Redis配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2Redis-Template"><span class="toc-number">9.2.</span> <span class="toc-text">9.2	Redis Template</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E8%8A%82%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">10.</span> <span class="toc-text">第十节	多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1Redis%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-number">10.1.</span> <span class="toc-text">10.1	Redis单线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2Redis%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">10.2.</span> <span class="toc-text">10.2	Redis多线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E8%8A%82BigKey"><span class="toc-number">11.</span> <span class="toc-text">第十一节	BigKey</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1MoreKey%E6%A1%88%E4%BE%8B"><span class="toc-number">11.1.</span> <span class="toc-text">11.1	MoreKey案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2BigKey%E6%A1%88%E4%BE%8B"><span class="toc-number">11.2.</span> <span class="toc-text">11.2	BigKey案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3BigKey%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98"><span class="toc-number">11.3.</span> <span class="toc-text">11.3	BigKey生产调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E8%8A%82%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">12.</span> <span class="toc-text">第十二节	缓存双写一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">12.1.</span> <span class="toc-text">12.1	缓存双写一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">12.2.</span> <span class="toc-text">12.2	更新策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%89%E8%8A%82%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1"><span class="toc-number">13.</span> <span class="toc-text">第十三节	大数据统计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1%E5%9B%9B%E7%A7%8D%E7%BB%9F%E8%AE%A1"><span class="toc-number">13.1.</span> <span class="toc-text">13.1	四种统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2hyperloglog"><span class="toc-number">13.2.</span> <span class="toc-text">13.2	hyperloglog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3%E7%BB%9F%E8%AE%A1%E4%BA%BF%E7%BA%A7UV%E7%9A%84Redis%E6%96%B9%E6%A1%88"><span class="toc-number">13.3.</span> <span class="toc-text">13.3	统计亿级UV的Redis方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%9B%9B%E8%8A%82%E5%AE%9E%E6%88%98GEO"><span class="toc-number">14.</span> <span class="toc-text">第十四节	实战GEO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%94%E8%8A%82%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">15.</span> <span class="toc-text">第十五节	布隆过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1BitMap"><span class="toc-number">15.1.</span> <span class="toc-text">15.1	BitMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">15.2.</span> <span class="toc-text">15.2	布隆过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%85%AD%E8%8A%82%E7%BC%93%E5%AD%98"><span class="toc-number">16.</span> <span class="toc-text">第十六节	缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16-1%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-number">16.1.</span> <span class="toc-text">16.1	缓存预热</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-2%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">16.2.</span> <span class="toc-text">16.2	缓存雪崩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">16.3.</span> <span class="toc-text">16.3	缓存穿透</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-4%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">16.4.</span> <span class="toc-text">16.4	缓存击穿</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%83%E8%8A%82%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">17.</span> <span class="toc-text">第十七节	分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17-1%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">17.1.</span> <span class="toc-text">17.1	分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-2%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">17.2.</span> <span class="toc-text">17.2	分布式锁的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%85%AB%E8%8A%82Redlock%E7%AE%97%E6%B3%95%E5%92%8CRedisson%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">18.</span> <span class="toc-text">第十八节	Redlock算法和Redisson的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#18-1Redlock%E7%BA%A2%E9%94%81%E7%AE%97%E6%B3%95"><span class="toc-number">18.1.</span> <span class="toc-text">18.1	Redlock红锁算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-2%E7%BA%A2%E9%94%81%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">18.2.</span> <span class="toc-text">18.2	红锁使用案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-3%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><span class="toc-number">18.3.</span> <span class="toc-text">18.3	缓存淘汰策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B9%9D%E8%8A%82Redis%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%BA%90%E7%A0%81"><span class="toc-number">19.</span> <span class="toc-text">第十九节	Redis数据类型源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#19-1Redis%E6%9E%B6%E6%9E%84"><span class="toc-number">19.1.</span> <span class="toc-text">19.1	Redis架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-2%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%BA%90%E7%A0%81"><span class="toc-number">19.2.</span> <span class="toc-text">19.2	五大数据类型源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8D%81%E8%8A%82IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-number">20.</span> <span class="toc-text">第二十节	IO多路复用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20-1Redis%E5%A4%9A%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5"><span class="toc-number">20.1.</span> <span class="toc-text">20.1	Redis多并发连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-2BIO"><span class="toc-number">20.2.</span> <span class="toc-text">20.2	BIO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-3NIO"><span class="toc-number">20.3.</span> <span class="toc-text">20.3	NIO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-4IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-number">20.4.</span> <span class="toc-text">20.4	IO多路复用</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/11/Shell/" title="Shell">Shell</a><time datetime="2024-06-11T13:27:53.000Z" title="发表于 2024-06-11 21:27:53">2024-06-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/06/Redis/" title="Redis">Redis</a><time datetime="2024-06-05T16:31:51.000Z" title="发表于 2024-06-06 00:31:51">2024-06-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/29/Python/" title="Python">Python</a><time datetime="2024-01-28T16:00:11.000Z" title="发表于 2024-01-29 00:00:11">2024-01-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/28/Mermaid/" title="Mermaid">Mermaid</a><time datetime="2024-01-28T15:21:32.000Z" title="发表于 2024-01-28 23:21:32">2024-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/28/HTTP/" title="HTTP">HTTP</a><time datetime="2024-01-28T15:20:44.000Z" title="发表于 2024-01-28 23:20:44">2024-01-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By huzzsea</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>